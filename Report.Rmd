---
title: "MovieLens Project Report"
author: "John Vincent Landingin"
date: "11/7/2021"
output: pdf_document
---

\tableofcontents 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# I. Overview

The goal of this project is to create a movie recommendation system with a model using the MovieLens dataset. The entire dataset is found in the following website: https://grouplens.org/datasets/movielens/latest/. However, only the 10M version of the MovieLens dataset (https://grouplens.org/datasets/movielens/10m/) is used for this project to make the computations easier.

```{r include=FALSE}
load("edx.rda")
load("validation.rda")
```

The dataset is initially divided into the edx set and the validation set. The algorithm is developed using the edx set, while the final test of the algorithm will be conducted using the validation set (the final hold-out test set) as if this was unknown. RMSE is used to evaluate how close the predictions are to the true values in the validation set (the final hold-out test set).

The following are the first six rows of the edx dataset:
```{r}
head(edx)
```

Below are the number of entries for the edx and validation datasets. 9000055 rows for the edx set and 999999 for the validation set.
```{r}
nrow(edx)
nrow(validation)
```
We use the following libraries:
```{r message=FALSE}
library(tidyverse)
library(caret)
library(stringr)
library(lubridate)
```

Furthermore, the edx set is divided into train_set and test_set. This is for designing and testing the algorithm. Below is the code to do that:

```{r eval=F, echo=T}
test_index <- createDataPartition(y = edx$rating, times = 1, p = 0.1, list = F)
train_set <- edx[-test_index,]
temp <- edx[test_index,]
test_set <- temp %>%
  semi_join(train_set, by = 'movieId') %>%
  semi_join(train_set, by = 'userId')
```

```{r include=FALSE}
load("train_set.rda")
load("test_set.rda")
```

The test_set and train_set is 10% and 90% of the edx set, respectively. Below are the number of entries for the test_set and train_set.
```{r}
nrow(test_set)
nrow(train_set)
```


To summarize, only the edx set is used to train the algorithm. In building the model, the features used to define the biases/effects are the following:  
1. Movie - mean rating per movie  
2. User - mean rating of each user  
3. Genre - mean rating of each user for a particular genre  
4. Year Movie was released

Later, we describe how the mentioned biases were used.

# II. Analysis

## Measuring model performance
The residual mean squared error (RMSE) is used to measure how close the model predictions are to the true values in the validation set (the final hold-out test set). This will also be used in building the model and testing the RMSE of multiple models, as well as tuning parameters and doing regularization but only on the test_set from the edx dataset. 

The following is the function that computes for the RMSE:
```{r}
RMSE <- function(true_ratings, predicted_ratings){
    sqrt(mean((true_ratings - predicted_ratings)^2))
  }
```

## Building the model
To start our model, we begin with just the average of all recorded ratings. This can be interpreted as a model that assumes the same rating for all movies and users with all the differences explained by random variation. The model would look like the following:

$$
Y_{u,i} = \mu + \varepsilon_{u,i}
$$

with $\varepsilon_{u,i}$ independent errors sampled from the same distribution centered at 0 and $\mu$ the “true” rating for all movies.

We find the mean using the following code:
```{r}
mu <- mean(train_set$rating)
mu
```
To test this model with just the average, we use the following code:
```{r}
rmse_average <- RMSE(test_set$rating, mu)
rmse_average
```

To improve our initial model with just the average, we check the distribution of the residuals of the predicted ratings of the model we have so far with the different biases/effects. This is so we can visualize if there is a universal pattern for each bias that we can find wherein we could fit our model to predict ratings. We do this step by step after each additional bias/effect added to the model.

## 1. Movie effect
```{r}
library(tidyverse)
movie_effect <- train_set %>% 
  group_by(movieId) %>% 
  summarize(b_i = mean(rating - mu))

movie_effect %>%
  ggplot(aes(b_i)) +
  geom_histogram(bins = 30, color = "black")
```
Based from the plot, we observe that there is substantial variation in the ratings, depending on what movie it is. It just goes to show that some movies are generally rated higher than others. Thus, we may add this to our model. The RMSE for this new model is as follows:

```{r}
pred <- test_set %>%
  left_join(movie_effect, by='movieId') %>%
  mutate(pred = mu + b_i) %>%
  .$pred

rmse_m <- RMSE(pred, test_set$rating)
rmse_m
```

The model would look like the following:
$$
Y_{u,i} = \mu + b_i + \varepsilon_{u,i}
$$
where $b_i$ represents average ranking for movie $i$

So far, below are our models and their RMSEs. 
```{r echo=FALSE}
data.frame(method = "Just the average", RMSE = rmse_average) %>%
  bind_rows(data.frame(method = "Movie Effect Model", RMSE = rmse_m))
```


## 2. User effect  
Next we check for user effect which is the average rating for each user. Below shows the average residuals of ratings from our previous model for each user. 
```{r}
user_effect <- train_set %>% 
  left_join(movie_effect, by = 'movieId') %>%
  group_by(userId) %>%
  summarize(b_u = mean(rating - mu - b_i))

user_effect %>%
  ggplot(aes(b_u)) +
  geom_histogram(bins = 30, color = "black")
```
We can observe from the plot that there is variation in the rating for each user. Thus, we add that to the model and get the following RMSE:
```{r}
pred <- test_set %>%
  left_join(movie_effect, by = 'movieId') %>%
  left_join(user_effect, by = 'userId') %>%
  mutate(pred = mu + b_i + b_u) %>%
  .$pred

rmse_mu <- RMSE(pred, test_set$rating)
rmse_mu 
```

The model would look like the following:
$$
Y_{u,i} = \mu + b_i + b_u + \varepsilon_{u,i}
$$
where $b_u$ represents a user-specific effect

So far, below are our models and their RMSEs. 
```{r echo=FALSE}
data.frame(method = "Just the average", RMSE = rmse_average) %>%
  bind_rows(data.frame(method = "Movie Effect Model", RMSE = rmse_m)) %>%
  bind_rows(data.frame(method = "Movie + User Effect Model", RMSE = rmse_mu))
```
## 3. Genre effect  
Below are all the genres in the edx set and their frequencies.
```{r}
genres <- unique(str_match(edx$genres, "[a-zA-Z]+"))[,1]

genre_count <- sapply(genres, function(x){
  y <- sum(str_detect(edx$genres, x))
  return(y)
})

data.frame(genre_count) %>%
  arrange(-genre_count)
```

Next we check for the genre effect. First we visualize if there is variation in the rating based from genre. We will not consider the genre 'no' since it is not a genre.
```{r visualize_genre, echo=FALSE, message=FALSE, fig.show='hide'}
fig <- train_set %>% 
  filter(userId %in% sample(unique(userId), size = 1000, replace = T)) %>%
  left_join(movie_effect, by = 'movieId') %>%
  left_join(user_effect, by = 'userId') %>%
  group_by(userId) %>%
  mutate(drama = mean(rating[str_detect(genres, "Drama")]) - mu - b_u - b_i,
         comedy = mean(rating[str_detect(genres, "Comedy")])- mu - b_u - b_i,
         action = mean(rating[str_detect(genres, "Action")])- mu - b_u - b_i,
         thriller = mean(rating[str_detect(genres, "Thriller")])- mu - b_u - b_i,
         adventure = mean(rating[str_detect(genres, "Adventure")])- mu - b_u - b_i,
         romance = mean(rating[str_detect(genres, "Romance")])- mu - b_u - b_i,
         sci = mean(rating[str_detect(genres, "Sci")])- mu - b_u - b_i,
         crime = mean(rating[str_detect(genres, "Crime")])- mu - b_u - b_i,
         fantasy = mean(rating[str_detect(genres, "Fantasy")])- mu - b_u - b_i,
         children = mean(rating[str_detect(genres, "Children")])- mu - b_u - b_i,
         horror = mean(rating[str_detect(genres, "Horror")])- mu - b_u - b_i,
         mystery = mean(rating[str_detect(genres, "Mystery")])- mu - b_u - b_i,
         war = mean(rating[str_detect(genres, "Was")])- mu - b_u - b_i,
         animation = mean(rating[str_detect(genres, "Animation")])- mu - b_u - b_i,
         musical = mean(rating[str_detect(genres, "Musical")])- mu - b_u - b_i,
         western = mean(rating[str_detect(genres, "Western")])- mu - b_u - b_i,
         film = mean(rating[str_detect(genres, "Film")])- mu - b_u - b_i,
         documentary = mean(rating[str_detect(genres, "Documentary")])- mu - b_u - b_i,
         imax = mean(rating[str_detect(genres, "Imax")])- mu - b_u - b_i) %>%
  gather(drama, comedy, action, thriller, adventure, romance, sci, 
         crime, fantasy, children, horror, mystery, war, animation, 
         musical, western, film, documentary, imax, key = "genre", value = average) %>%
  ungroup() %>% 
  group_by(userId, genre) %>%
  summarize(rating = mean(average)) %>%
  filter(!is.na(rating)) %>%
  ungroup() %>%
  mutate(genre = reorder(genre, rating, FUN = median)) %>%
  ggplot(aes(genre, rating, fill = genre)) +
  geom_boxplot() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  theme(legend.position = "none")

```
```{r echo=FALSE}
fig
```

As seen from the plot, there is only very slight differences in the average rating from genre to genre. Which may not give too much to our model. 

Below we try to look at average rating from genre to genre but for each user. We produce 5 plots sampling 5 users for each.

```{r echo=FALSE, error=FALSE, fig.keep='all', message=FALSE, warning=FALSE, figures-side, fig.show="hold", out.width="50%", results='hide'}
vis <- replicate(5,{
vis <- sample(seq(1,69878), size = 5, replace = F)
return(vis)
})

lapply(1:5, function(x){
train_set %>% filter(userId %in% vis[,x]) %>%
  left_join(movie_effect, by = 'movieId') %>%
  left_join(user_effect, by = 'userId') %>%
  group_by(userId) %>%
  mutate(drama = mean(rating[str_detect(genres, "Drama")]) - mu - b_u - b_i,
         comedy = mean(rating[str_detect(genres, "Comedy")])- mu - b_u - b_i,
         action = mean(rating[str_detect(genres, "Action")])- mu - b_u - b_i,
         thriller = mean(rating[str_detect(genres, "Thriller")])- mu - b_u - b_i,
         adventure = mean(rating[str_detect(genres, "Adventure")])- mu - b_u - b_i,
         romance = mean(rating[str_detect(genres, "Romance")])- mu - b_u - b_i,
         sci = mean(rating[str_detect(genres, "Sci")])- mu - b_u - b_i,
         crime = mean(rating[str_detect(genres, "Crime")])- mu - b_u - b_i,
         fantasy = mean(rating[str_detect(genres, "Fantasy")])- mu - b_u - b_i,
         children = mean(rating[str_detect(genres, "Children")])- mu - b_u - b_i,
         horror = mean(rating[str_detect(genres, "Horror")])- mu - b_u - b_i,
         mystery = mean(rating[str_detect(genres, "Mystery")])- mu - b_u - b_i,
         war = mean(rating[str_detect(genres, "Was")])- mu - b_u - b_i,
         animation = mean(rating[str_detect(genres, "Animation")])- mu - b_u - b_i,
         musical = mean(rating[str_detect(genres, "Musical")])- mu - b_u - b_i,
         western = mean(rating[str_detect(genres, "Western")])- mu - b_u - b_i,
         film = mean(rating[str_detect(genres, "Film")])- mu - b_u - b_i,
         documentary = mean(rating[str_detect(genres, "Documentary")])- mu - b_u - b_i,
         imax = mean(rating[str_detect(genres, "Imax")])- mu - b_u - b_i) %>%
  gather(drama, comedy, action, thriller, adventure, romance, sci, 
         crime, fantasy, children, horror, mystery, war, animation, 
         musical, western, film, documentary, imax, key = "genre", value = average) %>%
  ungroup() %>% 
  group_by(userId, genre) %>%
  summarize(b_genre = mean(average)) %>%
  filter(!is.na(b_genre)) %>%
  ungroup() %>%
  mutate(genre = reorder(genre, b_genre, FUN = median),
         userId = as.factor(userId)) %>%
  ggplot(aes(genre, b_genre, fill = genre)) +
  geom_point(aes(group = userId, color = userId), position = position_dodge(0.2), size = 2) +
  geom_line(aes(group = userId, color = userId), position = position_dodge(0.2), size = 1, alpha = 0.3) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  theme(legend.position = "none")

})
```

As observed from the plots, there is variability in the ratings of each user depending on the genre. This shows that some users may have different tastes in genres. 

So adding genre effects, the model would look like the following:
$$
Y_{u,i} = \mu + b_i + b_u + \sum_{k = 1}^K b_{k,u} + \varepsilon_{u,i}
$$
where $k$ is a genre and $b_{k,u}$ represents a genre-user effect

We add the genre effects to our model with the following code:
```{r Initial genres effect show, eval=FALSE, echo=TRUE}
comedy_effect <- train_set %>% 
  left_join(movie_effect, by = 'movieId') %>%
  left_join(user_effect, by = 'userId') %>%
  mutate(comedy = ifelse(str_detect(genres, "Comedy"), "1", "0"), pred = mu + b_u + b_i) %>%
  filter(comedy == "1") %>%
  group_by(userId) %>%
  summarize(b_comedy = mean(rating - pred))


drama_effect  <- train_set %>%
  left_join(movie_effect, by = 'movieId') %>%
  left_join(user_effect, by = 'userId') %>%
  left_join(comedy_effect, by = 'userId') %>%
  mutate(drama = ifelse(str_detect(genres, "Drama"), "1", "0"), 
         pred = mu + b_u + b_i + 
           ifelse(str_detect(genres, "Comedy") & !is.na(b_comedy), b_comedy, 0)) %>%
  filter(drama == "1") %>%
  group_by(userId) %>%
  summarize(b_drama = mean(rating - pred))

```
We continue the above code by adding the rest of the genres one by one.

```{r Initial genres effect, include=FALSE}
comedy_effect <- train_set %>% 
  left_join(movie_effect, by = 'movieId') %>%
  left_join(user_effect, by = 'userId') %>%
  mutate(comedy = ifelse(str_detect(genres, "Comedy"), "1", "0"), pred = mu + b_u + b_i) %>%
  filter(comedy == "1") %>%
  group_by(userId) %>%
  summarize(b_comedy = mean(rating - pred))


drama_effect  <- train_set %>%
  left_join(movie_effect, by = 'movieId') %>%
  left_join(user_effect, by = 'userId') %>%
  left_join(comedy_effect, by = 'userId') %>%
  mutate(drama = ifelse(str_detect(genres, "Drama"), "1", "0"), 
         pred = mu + b_u + b_i + 
           ifelse(str_detect(genres, "Comedy") & !is.na(b_comedy), b_comedy, 0)) %>%
  filter(drama == "1") %>%
  group_by(userId) %>%
  summarize(b_drama = mean(rating - pred))

action_effect <- train_set %>%
  left_join(movie_effect, by = 'movieId') %>%
  left_join(user_effect, by = 'userId') %>%
  left_join(comedy_effect, by = 'userId') %>%
  left_join(drama_effect, by = 'userId') %>%
  mutate(action = ifelse(str_detect(genres, "Action"), 1, 0),
         pred = mu + b_u + b_i +
           ifelse(str_detect(genres, "Comedy") & !is.na(b_comedy), b_comedy, 0) +
           ifelse(str_detect(genres, "Drama") & !is.na(b_drama), b_drama, 0)) %>%
  filter(action == 1) %>%
  group_by(userId) %>%
  summarize(b_action = mean(rating - pred))

thriller_effect <- train_set %>%
  left_join(movie_effect, by = 'movieId') %>%
  left_join(user_effect, by = 'userId') %>%
  left_join(comedy_effect, by = 'userId') %>%
  left_join(drama_effect, by = 'userId') %>%
  left_join(action_effect, by = 'userId') %>%
  mutate(thriller = ifelse(str_detect(genres, "Thriller"), 1, 0),
         pred = mu + b_u + b_i +
           ifelse(str_detect(genres, "Comedy") & !is.na(b_comedy), b_comedy, 0) +
           ifelse(str_detect(genres, "Drama") & !is.na(b_drama), b_drama, 0) +
           ifelse(str_detect(genres, "Action") & !is.na(b_action), b_action, 0)) %>%
  filter(thriller == 1) %>%
  group_by(userId) %>%
  summarize(b_thriller = mean(rating - pred))

adventure_effect <- train_set %>%
  left_join(movie_effect, by = 'movieId') %>%
  left_join(user_effect, by = 'userId') %>%
  left_join(comedy_effect, by = 'userId') %>%
  left_join(drama_effect, by = 'userId') %>%
  left_join(action_effect, by = 'userId') %>%
  left_join(thriller_effect, by = 'userId') %>%
  mutate(adventure = ifelse(str_detect(genres, "Adventure"), 1, 0),
         pred = mu + b_u + b_i +
           ifelse(str_detect(genres, "Comedy") & !is.na(b_comedy), b_comedy, 0) +
           ifelse(str_detect(genres, "Drama") & !is.na(b_drama), b_drama, 0) +
           ifelse(str_detect(genres, "Action") & !is.na(b_action), b_action, 0) +
           ifelse(str_detect(genres, "Thriller") & !is.na(b_thriller), b_thriller, 0)) %>%
  filter(adventure == 1) %>%
  group_by(userId) %>%
  summarize(b_adventure = mean(rating - pred))

romance_effect <- train_set %>%
  left_join(movie_effect, by = 'movieId') %>%
  left_join(user_effect, by = 'userId') %>%
  left_join(comedy_effect, by = 'userId') %>%
  left_join(drama_effect, by = 'userId') %>%
  left_join(action_effect, by = 'userId') %>%
  left_join(thriller_effect, by = 'userId') %>%
  left_join(adventure_effect, by = 'userId') %>%
  mutate(romance = ifelse(str_detect(genres, "Romance"), 1, 0),
         pred = mu + b_u + b_i +
           ifelse(str_detect(genres, "Comedy") & !is.na(b_comedy), b_comedy, 0) +
           ifelse(str_detect(genres, "Drama") & !is.na(b_drama), b_drama, 0) +
           ifelse(str_detect(genres, "Action") & !is.na(b_action), b_action, 0) +
           ifelse(str_detect(genres, "Thriller") & !is.na(b_thriller), b_thriller, 0) + 
           ifelse(str_detect(genres, "Adventure") & !is.na(b_adventure), b_adventure, 0)) %>%
  filter(romance == 1) %>%
  group_by(userId) %>%
  summarize(b_romance = mean(rating - pred))

sci_effect <- train_set %>%
  left_join(movie_effect, by = 'movieId') %>%
  left_join(user_effect, by = 'userId') %>%
  left_join(comedy_effect, by = 'userId') %>%
  left_join(drama_effect, by = 'userId') %>%
  left_join(action_effect, by = 'userId') %>%
  left_join(thriller_effect, by = 'userId') %>%
  left_join(adventure_effect, by = 'userId') %>%
  left_join(romance_effect, by = 'userId') %>%
  mutate(sci = ifelse(str_detect(genres, "Sci"), 1, 0),
         pred = mu + b_u + b_i +
           ifelse(str_detect(genres, "Comedy") & !is.na(b_comedy), b_comedy, 0) +
           ifelse(str_detect(genres, "Drama") & !is.na(b_drama), b_drama, 0) +
           ifelse(str_detect(genres, "Action") & !is.na(b_action), b_action, 0) +
           ifelse(str_detect(genres, "Thriller") & !is.na(b_thriller), b_thriller, 0) + 
           ifelse(str_detect(genres, "Adventure") & !is.na(b_adventure), b_adventure, 0) + 
           ifelse(str_detect(genres, "Romance") & !is.na(b_romance), b_romance, 0)) %>%
  filter(sci == 1) %>%
  group_by(userId) %>%
  summarize(b_sci = mean(rating - pred))

crime_effect <- train_set %>%
  left_join(movie_effect, by = 'movieId') %>%
  left_join(user_effect, by = 'userId') %>%
  left_join(comedy_effect, by = 'userId') %>%
  left_join(drama_effect, by = 'userId') %>%
  left_join(action_effect, by = 'userId') %>%
  left_join(thriller_effect, by = 'userId') %>%
  left_join(adventure_effect, by = 'userId') %>%
  left_join(romance_effect, by = 'userId') %>%
  left_join(sci_effect, by = 'userId') %>%
  mutate(crime = ifelse(str_detect(genres, "Crime"), 1, 0),
         pred = mu + b_u + b_i +
           ifelse(str_detect(genres, "Comedy") & !is.na(b_comedy), b_comedy, 0) +
           ifelse(str_detect(genres, "Drama") & !is.na(b_drama), b_drama, 0) +
           ifelse(str_detect(genres, "Action") & !is.na(b_action), b_action, 0) +
           ifelse(str_detect(genres, "Thriller") & !is.na(b_thriller), b_thriller, 0) + 
           ifelse(str_detect(genres, "Adventure") & !is.na(b_adventure), b_adventure, 0) + 
           ifelse(str_detect(genres, "Romance") & !is.na(b_romance), b_romance, 0) + 
           ifelse(str_detect(genres, "Sci") & !is.na(b_sci), b_sci, 0)) %>%
  filter(crime == 1) %>%
  group_by(userId) %>%
  summarize(b_crime = mean(rating - pred))

fantasy_effect <- train_set %>%
  left_join(movie_effect, by = 'movieId') %>%
  left_join(user_effect, by = 'userId') %>%
  left_join(comedy_effect, by = 'userId') %>%
  left_join(drama_effect, by = 'userId') %>%
  left_join(action_effect, by = 'userId') %>%
  left_join(thriller_effect, by = 'userId') %>%
  left_join(adventure_effect, by = 'userId') %>%
  left_join(romance_effect, by = 'userId') %>%
  left_join(sci_effect, by = 'userId') %>%
  left_join(crime_effect, by = 'userId') %>%
  mutate(fantasy = ifelse(str_detect(genres, "Fantasy"), 1, 0),
         pred = mu + b_u + b_i +
           ifelse(str_detect(genres, "Comedy") & !is.na(b_comedy), b_comedy, 0) +
           ifelse(str_detect(genres, "Drama") & !is.na(b_drama), b_drama, 0) +
           ifelse(str_detect(genres, "Action") & !is.na(b_action), b_action, 0) +
           ifelse(str_detect(genres, "Thriller") & !is.na(b_thriller), b_thriller, 0) + 
           ifelse(str_detect(genres, "Adventure") & !is.na(b_adventure), b_adventure, 0) + 
           ifelse(str_detect(genres, "Romance") & !is.na(b_romance), b_romance, 0) + 
           ifelse(str_detect(genres, "Sci") & !is.na(b_sci), b_sci, 0) +
           ifelse(str_detect(genres, "Crime") & !is.na(b_crime), b_crime, 0)
         ) %>%
  filter(fantasy == 1) %>%
  group_by(userId) %>%
  summarize(b_fantasy = mean(rating - pred))

children_effect <- train_set %>%
  left_join(movie_effect, by = 'movieId') %>%
  left_join(user_effect, by = 'userId') %>%
  left_join(comedy_effect, by = 'userId') %>%
  left_join(drama_effect, by = 'userId') %>%
  left_join(action_effect, by = 'userId') %>%
  left_join(thriller_effect, by = 'userId') %>%
  left_join(adventure_effect, by = 'userId') %>%
  left_join(romance_effect, by = 'userId') %>%
  left_join(sci_effect, by = 'userId') %>%
  left_join(crime_effect, by = 'userId') %>%
  left_join(fantasy_effect, by = 'userId') %>%
  mutate(children = ifelse(str_detect(genres, "Children"), 1, 0),
         pred = mu + b_u + b_i +
           ifelse(str_detect(genres, "Comedy") & !is.na(b_comedy), b_comedy, 0) +
           ifelse(str_detect(genres, "Drama") & !is.na(b_drama), b_drama, 0) +
           ifelse(str_detect(genres, "Action") & !is.na(b_action), b_action, 0) +
           ifelse(str_detect(genres, "Thriller") & !is.na(b_thriller), b_thriller, 0) + 
           ifelse(str_detect(genres, "Adventure") & !is.na(b_adventure), b_adventure, 0) + 
           ifelse(str_detect(genres, "Romance") & !is.na(b_romance), b_romance, 0) + 
           ifelse(str_detect(genres, "Sci") & !is.na(b_sci), b_sci, 0) +
           ifelse(str_detect(genres, "Crime") & !is.na(b_crime), b_crime, 0) +
           ifelse(str_detect(genres, "Fantasy") & !is.na(b_fantasy), b_fantasy, 0)
  ) %>%
  filter(children == 1) %>%
  group_by(userId) %>%
  summarize(b_children = mean(rating - pred))

horror_effect <- train_set %>%
  left_join(movie_effect, by = 'movieId') %>%
  left_join(user_effect, by = 'userId') %>%
  left_join(comedy_effect, by = 'userId') %>%
  left_join(drama_effect, by = 'userId') %>%
  left_join(action_effect, by = 'userId') %>%
  left_join(thriller_effect, by = 'userId') %>%
  left_join(adventure_effect, by = 'userId') %>%
  left_join(romance_effect, by = 'userId') %>%
  left_join(sci_effect, by = 'userId') %>%
  left_join(crime_effect, by = 'userId') %>%
  left_join(fantasy_effect, by = 'userId') %>%
  left_join(children_effect, by = 'userId') %>%
  mutate(horror = ifelse(str_detect(genres, "Horror"), 1, 0),
         pred = mu + b_u + b_i +
           ifelse(str_detect(genres, "Comedy") & !is.na(b_comedy), b_comedy, 0) +
           ifelse(str_detect(genres, "Drama") & !is.na(b_drama), b_drama, 0) +
           ifelse(str_detect(genres, "Action") & !is.na(b_action), b_action, 0) +
           ifelse(str_detect(genres, "Thriller") & !is.na(b_thriller), b_thriller, 0) + 
           ifelse(str_detect(genres, "Adventure") & !is.na(b_adventure), b_adventure, 0) + 
           ifelse(str_detect(genres, "Romance") & !is.na(b_romance), b_romance, 0) + 
           ifelse(str_detect(genres, "Sci") & !is.na(b_sci), b_sci, 0) +
           ifelse(str_detect(genres, "Crime") & !is.na(b_crime), b_crime, 0) +
           ifelse(str_detect(genres, "Fantasy") & !is.na(b_fantasy), b_fantasy, 0) +
           ifelse(str_detect(genres, "Children") & !is.na(b_children), b_children, 0)
  ) %>%
  filter(horror == 1) %>%
  group_by(userId) %>%
  summarize(b_horror = mean(rating - pred))

mystery_effect <- train_set %>%
  left_join(movie_effect, by = 'movieId') %>%
  left_join(user_effect, by = 'userId') %>%
  left_join(comedy_effect, by = 'userId') %>%
  left_join(drama_effect, by = 'userId') %>%
  left_join(action_effect, by = 'userId') %>%
  left_join(thriller_effect, by = 'userId') %>%
  left_join(adventure_effect, by = 'userId') %>%
  left_join(romance_effect, by = 'userId') %>%
  left_join(sci_effect, by = 'userId') %>%
  left_join(crime_effect, by = 'userId') %>%
  left_join(fantasy_effect, by = 'userId') %>%
  left_join(children_effect, by = 'userId') %>%
  left_join(horror_effect, by = 'userId') %>%
  mutate(mystery = ifelse(str_detect(genres, "Mystery"), 1, 0),
         pred = mu + b_u + b_i +
           ifelse(str_detect(genres, "Comedy") & !is.na(b_comedy), b_comedy, 0) +
           ifelse(str_detect(genres, "Drama") & !is.na(b_drama), b_drama, 0) +
           ifelse(str_detect(genres, "Action") & !is.na(b_action), b_action, 0) +
           ifelse(str_detect(genres, "Thriller") & !is.na(b_thriller), b_thriller, 0) + 
           ifelse(str_detect(genres, "Adventure") & !is.na(b_adventure), b_adventure, 0) + 
           ifelse(str_detect(genres, "Romance") & !is.na(b_romance), b_romance, 0) + 
           ifelse(str_detect(genres, "Sci") & !is.na(b_sci), b_sci, 0) +
           ifelse(str_detect(genres, "Crime") & !is.na(b_crime), b_crime, 0) +
           ifelse(str_detect(genres, "Fantasy") & !is.na(b_fantasy), b_fantasy, 0) +
           ifelse(str_detect(genres, "Children") & !is.na(b_children), b_children, 0) +
           ifelse(str_detect(genres, "Horror") & !is.na(b_horror), b_horror, 0)
  ) %>%
  filter(mystery == 1) %>%
  group_by(userId) %>%
  summarize(b_mystery = mean(rating - pred))

war_effect <- train_set %>%
  left_join(movie_effect, by = 'movieId') %>%
  left_join(user_effect, by = 'userId') %>%
  left_join(comedy_effect, by = 'userId') %>%
  left_join(drama_effect, by = 'userId') %>%
  left_join(action_effect, by = 'userId') %>%
  left_join(thriller_effect, by = 'userId') %>%
  left_join(adventure_effect, by = 'userId') %>%
  left_join(romance_effect, by = 'userId') %>%
  left_join(sci_effect, by = 'userId') %>%
  left_join(crime_effect, by = 'userId') %>%
  left_join(fantasy_effect, by = 'userId') %>%
  left_join(children_effect, by = 'userId') %>%
  left_join(horror_effect, by = 'userId') %>%
  left_join(mystery_effect, by = 'userId') %>%
  mutate(war = ifelse(str_detect(genres, "War"), 1, 0),
         pred = mu + b_u + b_i +
           ifelse(str_detect(genres, "Comedy") & !is.na(b_comedy), b_comedy, 0) +
           ifelse(str_detect(genres, "Drama") & !is.na(b_drama), b_drama, 0) +
           ifelse(str_detect(genres, "Action") & !is.na(b_action), b_action, 0) +
           ifelse(str_detect(genres, "Thriller") & !is.na(b_thriller), b_thriller, 0) +
           ifelse(str_detect(genres, "Adventure") & !is.na(b_adventure), b_adventure, 0) +
           ifelse(str_detect(genres, "Romance") & !is.na(b_romance), b_romance, 0) +
           ifelse(str_detect(genres, "Sci") & !is.na(b_sci), b_sci, 0) +
           ifelse(str_detect(genres, "Crime") & !is.na(b_crime), b_crime, 0) +
           ifelse(str_detect(genres, "Fantasy") & !is.na(b_fantasy), b_fantasy, 0) +
           ifelse(str_detect(genres, "Children") & !is.na(b_children), b_children, 0) +
           ifelse(str_detect(genres, "Horror") & !is.na(b_horror), b_horror, 0) +
           ifelse(str_detect(genres, "Mystery") & !is.na(b_mystery), b_mystery, 0)
  ) %>%
  filter(war == 1) %>%
  group_by(userId) %>%
  summarize(b_war = mean(rating - pred))

animation_effect <- train_set %>%
  left_join(movie_effect, by = 'movieId') %>%
  left_join(user_effect, by = 'userId') %>%
  left_join(comedy_effect, by = 'userId') %>%
  left_join(drama_effect, by = 'userId') %>%
  left_join(action_effect, by = 'userId') %>%
  left_join(thriller_effect, by = 'userId') %>%
  left_join(adventure_effect, by = 'userId') %>%
  left_join(romance_effect, by = 'userId') %>%
  left_join(sci_effect, by = 'userId') %>%
  left_join(crime_effect, by = 'userId') %>%
  left_join(fantasy_effect, by = 'userId') %>%
  left_join(children_effect, by = 'userId') %>%
  left_join(horror_effect, by = 'userId') %>%
  left_join(mystery_effect, by = 'userId') %>%
  left_join(war_effect, by = 'userId') %>%
  mutate(pred = mu + b_u + b_i +
           ifelse(str_detect(genres, "Comedy") & !is.na(b_comedy), b_comedy, 0) +
           ifelse(str_detect(genres, "Drama") & !is.na(b_drama), b_drama, 0) +
           ifelse(str_detect(genres, "Action") & !is.na(b_action), b_action, 0) +
           ifelse(str_detect(genres, "Thriller") & !is.na(b_thriller), b_thriller, 0) + 
           ifelse(str_detect(genres, "Adventure") & !is.na(b_adventure), b_adventure, 0) + 
           ifelse(str_detect(genres, "Romance") & !is.na(b_romance), b_romance, 0) + 
           ifelse(str_detect(genres, "Sci") & !is.na(b_sci), b_sci, 0) + 
           ifelse(str_detect(genres, "Crime") & !is.na(b_crime), b_crime, 0) +
           ifelse(str_detect(genres, "Fantasy") & !is.na(b_fantasy), b_fantasy, 0) +
           ifelse(str_detect(genres, "Children") & !is.na(b_children), b_children, 0) +
           ifelse(str_detect(genres, "Horror") & !is.na(b_horror), b_horror, 0) +
           ifelse(str_detect(genres, "Mystery") & !is.na(b_mystery), b_mystery, 0) +
           ifelse(str_detect(genres, "War") & !is.na(b_war), b_war, 0)
  ) %>%
  mutate(animation = ifelse(str_detect(genres, "Animation"), 1, 0)) %>%
  filter(animation == 1) %>%
  group_by(userId) %>%
  summarize(b_animation = mean(rating - pred))

musical_effect <- train_set %>%
  left_join(movie_effect, by = 'movieId') %>%
  left_join(user_effect, by = 'userId') %>%
  left_join(comedy_effect, by = 'userId') %>%
  left_join(drama_effect, by = 'userId') %>%
  left_join(action_effect, by = 'userId') %>%
  left_join(thriller_effect, by = 'userId') %>%
  left_join(adventure_effect, by = 'userId') %>%
  left_join(romance_effect, by = 'userId') %>%
  left_join(sci_effect, by = 'userId') %>%
  left_join(crime_effect, by = 'userId') %>%
  left_join(fantasy_effect, by = 'userId') %>%
  left_join(children_effect, by = 'userId') %>%
  left_join(horror_effect, by = 'userId') %>%
  left_join(mystery_effect, by = 'userId') %>%
  left_join(war_effect, by = 'userId') %>%
  left_join(animation_effect, by = 'userId') %>%
  mutate(pred = mu + b_u + b_i +
           ifelse(str_detect(genres, "Comedy") & !is.na(b_comedy), b_comedy, 0) +
           ifelse(str_detect(genres, "Drama") & !is.na(b_drama), b_drama, 0) +
           ifelse(str_detect(genres, "Action") & !is.na(b_action), b_action, 0) +
           ifelse(str_detect(genres, "Thriller") & !is.na(b_thriller), b_thriller, 0) + 
           ifelse(str_detect(genres, "Adventure") & !is.na(b_adventure), b_adventure, 0) + 
           ifelse(str_detect(genres, "Romance") & !is.na(b_romance), b_romance, 0) + 
           ifelse(str_detect(genres, "Sci") & !is.na(b_sci), b_sci, 0) + 
           ifelse(str_detect(genres, "Crime") & !is.na(b_crime), b_crime, 0) +
           ifelse(str_detect(genres, "Fantasy") & !is.na(b_fantasy), b_fantasy, 0) +
           ifelse(str_detect(genres, "Children") & !is.na(b_children), b_children, 0) +
           ifelse(str_detect(genres, "Horror") & !is.na(b_horror), b_horror, 0) +
           ifelse(str_detect(genres, "Mystery") & !is.na(b_mystery), b_mystery, 0) +
           ifelse(str_detect(genres, "War") & !is.na(b_war), b_war, 0) +
           ifelse(str_detect(genres, "Animation") & !is.na(b_animation), b_animation, 0)
  ) %>%
  mutate(musical = ifelse(str_detect(genres, "Musical"), 1, 0)) %>%
  filter(musical == 1) %>%
  group_by(userId) %>%
  summarize(b_musical = mean(rating - pred))

western_effect <- train_set %>%
  left_join(movie_effect, by = 'movieId') %>%
  left_join(user_effect, by = 'userId') %>%
  left_join(comedy_effect, by = 'userId') %>%
  left_join(drama_effect, by = 'userId') %>%
  left_join(action_effect, by = 'userId') %>%
  left_join(thriller_effect, by = 'userId') %>%
  left_join(adventure_effect, by = 'userId') %>%
  left_join(romance_effect, by = 'userId') %>%
  left_join(sci_effect, by = 'userId') %>%
  left_join(crime_effect, by = 'userId') %>%
  left_join(fantasy_effect, by = 'userId') %>%
  left_join(children_effect, by = 'userId') %>%
  left_join(horror_effect, by = 'userId') %>%
  left_join(mystery_effect, by = 'userId') %>%
  left_join(war_effect, by = 'userId') %>%
  left_join(animation_effect, by = 'userId') %>%
  left_join(musical_effect, by = 'userId') %>%
  mutate(pred = mu + b_u + b_i +
           ifelse(str_detect(genres, "Comedy") & !is.na(b_comedy), b_comedy, 0) +
           ifelse(str_detect(genres, "Drama") & !is.na(b_drama), b_drama, 0) +
           ifelse(str_detect(genres, "Action") & !is.na(b_action), b_action, 0) +
           ifelse(str_detect(genres, "Thriller") & !is.na(b_thriller), b_thriller, 0) + 
           ifelse(str_detect(genres, "Adventure") & !is.na(b_adventure), b_adventure, 0) + 
           ifelse(str_detect(genres, "Romance") & !is.na(b_romance), b_romance, 0) + 
           ifelse(str_detect(genres, "Sci") & !is.na(b_sci), b_sci, 0) + 
           ifelse(str_detect(genres, "Crime") & !is.na(b_crime), b_crime, 0) +
           ifelse(str_detect(genres, "Fantasy") & !is.na(b_fantasy), b_fantasy, 0) +
           ifelse(str_detect(genres, "Children") & !is.na(b_children), b_children, 0) +
           ifelse(str_detect(genres, "Horror") & !is.na(b_horror), b_horror, 0) +
           ifelse(str_detect(genres, "Mystery") & !is.na(b_mystery), b_mystery, 0) +
           ifelse(str_detect(genres, "War") & !is.na(b_war), b_war, 0) +
           ifelse(str_detect(genres, "Animation") & !is.na(b_animation), b_animation, 0) +
           ifelse(str_detect(genres, "Musical") & !is.na(b_musical), b_musical, 0)
  ) %>%
  mutate(western = ifelse(str_detect(genres, "Western"), 1, 0)) %>%
  filter(western == 1) %>%
  group_by(userId) %>%
  summarize(b_western = mean(rating - pred))

film_effect <- train_set %>%
  left_join(movie_effect, by = 'movieId') %>%
  left_join(user_effect, by = 'userId') %>%
  left_join(comedy_effect, by = 'userId') %>%
  left_join(drama_effect, by = 'userId') %>%
  left_join(action_effect, by = 'userId') %>%
  left_join(thriller_effect, by = 'userId') %>%
  left_join(adventure_effect, by = 'userId') %>%
  left_join(romance_effect, by = 'userId') %>%
  left_join(sci_effect, by = 'userId') %>%
  left_join(crime_effect, by = 'userId') %>%
  left_join(fantasy_effect, by = 'userId') %>%
  left_join(children_effect, by = 'userId') %>%
  left_join(horror_effect, by = 'userId') %>%
  left_join(mystery_effect, by = 'userId') %>%
  left_join(war_effect, by = 'userId') %>%
  left_join(animation_effect, by = 'userId') %>%
  left_join(musical_effect, by = 'userId') %>%
  left_join(western_effect, by = 'userId') %>%
  mutate(pred = mu + b_u + b_i +
           ifelse(str_detect(genres, "Comedy") & !is.na(b_comedy), b_comedy, 0) +
           ifelse(str_detect(genres, "Drama") & !is.na(b_drama), b_drama, 0) +
           ifelse(str_detect(genres, "Action") & !is.na(b_action), b_action, 0) +
           ifelse(str_detect(genres, "Thriller") & !is.na(b_thriller), b_thriller, 0) + 
           ifelse(str_detect(genres, "Adventure") & !is.na(b_adventure), b_adventure, 0) + 
           ifelse(str_detect(genres, "Romance") & !is.na(b_romance), b_romance, 0) + 
           ifelse(str_detect(genres, "Sci") & !is.na(b_sci), b_sci, 0) + 
           ifelse(str_detect(genres, "Crime") & !is.na(b_crime), b_crime, 0) +
           ifelse(str_detect(genres, "Fantasy") & !is.na(b_fantasy), b_fantasy, 0) +
           ifelse(str_detect(genres, "Children") & !is.na(b_children), b_children, 0) +
           ifelse(str_detect(genres, "Horror") & !is.na(b_horror), b_horror, 0) +
           ifelse(str_detect(genres, "Mystery") & !is.na(b_mystery), b_mystery, 0) +
           ifelse(str_detect(genres, "War") & !is.na(b_war), b_war, 0) +
           ifelse(str_detect(genres, "Animation") & !is.na(b_animation), b_animation, 0) +
           ifelse(str_detect(genres, "Musical") & !is.na(b_musical), b_musical, 0) +
           ifelse(str_detect(genres, "Western") & !is.na(b_western), b_western, 0)
  ) %>%
  mutate(film = ifelse(str_detect(genres, "Film"), 1, 0)) %>%
  filter(film == 1) %>%
  group_by(userId) %>%
  summarize(b_film = mean(rating - pred))

documentary_effect <- train_set %>%
  left_join(movie_effect, by = 'movieId') %>%
  left_join(user_effect, by = 'userId') %>%
  left_join(comedy_effect, by = 'userId') %>%
  left_join(drama_effect, by = 'userId') %>%
  left_join(action_effect, by = 'userId') %>%
  left_join(thriller_effect, by = 'userId') %>%
  left_join(adventure_effect, by = 'userId') %>%
  left_join(romance_effect, by = 'userId') %>%
  left_join(sci_effect, by = 'userId') %>%
  left_join(crime_effect, by = 'userId') %>%
  left_join(fantasy_effect, by = 'userId') %>%
  left_join(children_effect, by = 'userId') %>%
  left_join(horror_effect, by = 'userId') %>%
  left_join(mystery_effect, by = 'userId') %>%
  left_join(war_effect, by = 'userId') %>%
  left_join(animation_effect, by = 'userId') %>%
  left_join(musical_effect, by = 'userId') %>%
  left_join(western_effect, by = 'userId') %>%
  left_join(film_effect, by = 'userId') %>%
  mutate(pred = mu + b_u + b_i +
           ifelse(str_detect(genres, "Comedy") & !is.na(b_comedy), b_comedy, 0) +
           ifelse(str_detect(genres, "Drama") & !is.na(b_drama), b_drama, 0) +
           ifelse(str_detect(genres, "Action") & !is.na(b_action), b_action, 0) +
           ifelse(str_detect(genres, "Thriller") & !is.na(b_thriller), b_thriller, 0) + 
           ifelse(str_detect(genres, "Adventure") & !is.na(b_adventure), b_adventure, 0) + 
           ifelse(str_detect(genres, "Romance") & !is.na(b_romance), b_romance, 0) + 
           ifelse(str_detect(genres, "Sci") & !is.na(b_sci), b_sci, 0) + 
           ifelse(str_detect(genres, "Crime") & !is.na(b_crime), b_crime, 0) +
           ifelse(str_detect(genres, "Fantasy") & !is.na(b_fantasy), b_fantasy, 0) +
           ifelse(str_detect(genres, "Children") & !is.na(b_children), b_children, 0) +
           ifelse(str_detect(genres, "Horror") & !is.na(b_horror), b_horror, 0) +
           ifelse(str_detect(genres, "Mystery") & !is.na(b_mystery), b_mystery, 0) +
           ifelse(str_detect(genres, "War") & !is.na(b_war), b_war, 0) +
           ifelse(str_detect(genres, "Animation") & !is.na(b_animation), b_animation, 0) +
           ifelse(str_detect(genres, "Musical") & !is.na(b_musical), b_musical, 0) +
           ifelse(str_detect(genres, "Western") & !is.na(b_western), b_western, 0) +
           ifelse(str_detect(genres, "Film") & !is.na(b_film), b_film, 0)
  ) %>%
  mutate(documentary = ifelse(str_detect(genres, "Documentary"), 1, 0)) %>%
  filter(documentary == 1) %>%
  group_by(userId) %>%
  summarize(b_documentary = mean(rating - pred))

imax_effect <- train_set %>%
  left_join(movie_effect, by = 'movieId') %>%
  left_join(user_effect, by = 'userId') %>%
  left_join(comedy_effect, by = 'userId') %>%
  left_join(drama_effect, by = 'userId') %>%
  left_join(action_effect, by = 'userId') %>%
  left_join(thriller_effect, by = 'userId') %>%
  left_join(adventure_effect, by = 'userId') %>%
  left_join(romance_effect, by = 'userId') %>%
  left_join(sci_effect, by = 'userId') %>%
  left_join(crime_effect, by = 'userId') %>%
  left_join(fantasy_effect, by = 'userId') %>%
  left_join(children_effect, by = 'userId') %>%
  left_join(horror_effect, by = 'userId') %>%
  left_join(mystery_effect, by = 'userId') %>%
  left_join(war_effect, by = 'userId') %>%
  left_join(animation_effect, by = 'userId') %>%
  left_join(musical_effect, by = 'userId') %>%
  left_join(western_effect, by = 'userId') %>%
  left_join(film_effect, by = 'userId') %>%
  left_join(documentary_effect, by = 'userId') %>%
  mutate(pred = mu + b_u + b_i +
           ifelse(str_detect(genres, "Comedy") & !is.na(b_comedy), b_comedy, 0) +
           ifelse(str_detect(genres, "Drama") & !is.na(b_drama), b_drama, 0) +
           ifelse(str_detect(genres, "Action") & !is.na(b_action), b_action, 0) +
           ifelse(str_detect(genres, "Thriller") & !is.na(b_thriller), b_thriller, 0) + 
           ifelse(str_detect(genres, "Adventure") & !is.na(b_adventure), b_adventure, 0) + 
           ifelse(str_detect(genres, "Romance") & !is.na(b_romance), b_romance, 0) + 
           ifelse(str_detect(genres, "Sci") & !is.na(b_sci), b_sci, 0) + 
           ifelse(str_detect(genres, "Crime") & !is.na(b_crime), b_crime, 0) +
           ifelse(str_detect(genres, "Fantasy") & !is.na(b_fantasy), b_fantasy, 0) +
           ifelse(str_detect(genres, "Children") & !is.na(b_children), b_children, 0) +
           ifelse(str_detect(genres, "Horror") & !is.na(b_horror), b_horror, 0) +
           ifelse(str_detect(genres, "Mystery") & !is.na(b_mystery), b_mystery, 0) +
           ifelse(str_detect(genres, "War") & !is.na(b_war), b_war, 0) +
           ifelse(str_detect(genres, "Animation") & !is.na(b_animation), b_animation, 0) +
           ifelse(str_detect(genres, "Musical") & !is.na(b_musical), b_musical, 0) +
           ifelse(str_detect(genres, "Western") & !is.na(b_western), b_western, 0) +
           ifelse(str_detect(genres, "Film") & !is.na(b_film), b_film, 0) +
           ifelse(str_detect(genres, "Documentary") & !is.na(b_documentary), b_documentary, 0)
  ) %>%
  mutate(imax = ifelse(str_detect(genres, "IMAX"), 1, 0)) %>%
  filter(imax == 1) %>%
  group_by(userId) %>%
  summarize(b_imax = mean(rating - pred))
```

We check the RMSE of the new model with genre effect with the following code:

```{r include=FALSE}
pred <- test_set %>% 
  left_join(movie_effect, by = 'movieId') %>%
  left_join(user_effect, by = 'userId') %>%
  left_join(comedy_effect, by = 'userId') %>%
  left_join(drama_effect, by = 'userId') %>%
  left_join(action_effect, by = 'userId') %>%
  left_join(thriller_effect, by = 'userId') %>%
  left_join(adventure_effect, by = 'userId') %>%
  left_join(romance_effect, by = 'userId') %>%
  left_join(sci_effect, by = 'userId') %>%
  left_join(crime_effect, by = 'userId') %>%
  left_join(fantasy_effect, by = 'userId') %>%
  left_join(children_effect, by = 'userId') %>%
  left_join(horror_effect, by = 'userId') %>%
  left_join(mystery_effect, by = 'userId') %>%
  left_join(war_effect, by = 'userId') %>%
  left_join(animation_effect, by = 'userId') %>%
  left_join(musical_effect, by = 'userId') %>%
  left_join(western_effect, by = 'userId') %>%
  left_join(film_effect, by = 'userId') %>%
  left_join(documentary_effect, by = 'userId') %>%
  left_join(imax_effect, by = 'userId') %>%
  select(-timestamp, -title) %>%
  mutate(pred = mu + b_i + b_u,
         newpred = pred + 
           ifelse(str_detect(genres, "Comedy") & !is.na(b_comedy), b_comedy, 0) + 
           ifelse(str_detect(genres, "Drama") & !is.na(b_drama), b_drama, 0) +
           ifelse(str_detect(genres, "Action") & !is.na(b_action), b_action, 0) +
           ifelse(str_detect(genres, "Thriller") & !is.na(b_thriller), b_thriller, 0) +
           ifelse(str_detect(genres, "Adventure") & !is.na(b_adventure), b_adventure, 0) +
           ifelse(str_detect(genres, "Romance") & !is.na(b_romance), b_romance, 0) +
           ifelse(str_detect(genres, "Sci") & !is.na(b_sci), b_sci, 0) + 
           ifelse(str_detect(genres, "Crime") & !is.na(b_crime), b_crime, 0) +
           ifelse(str_detect(genres, "Fantasy") & !is.na(b_fantasy), b_fantasy, 0) +
           ifelse(str_detect(genres, "Children") & !is.na(b_children), b_children, 0) +
           ifelse(str_detect(genres, "Horror") & !is.na(b_horror), b_horror, 0) +
           ifelse(str_detect(genres, "Mystery") & !is.na(b_mystery), b_mystery, 0) +
           ifelse(str_detect(genres, "War") & !is.na(b_war), b_war, 0) +
           ifelse(str_detect(genres, "Animation") & !is.na(b_animation), b_animation, 0) +
           ifelse(str_detect(genres, "Musical") & !is.na(b_musical), b_musical, 0) +
           ifelse(str_detect(genres, "Western") & !is.na(b_western), b_western, 0) +
           ifelse(str_detect(genres, "Film") & !is.na(b_film), b_film, 0) +
           ifelse(str_detect(genres, "Documentary") & !is.na(b_documentary), 
                  b_documentary, 0) +
           ifelse(str_detect(genres, "IMAX") & !is.na(b_imax), b_imax, 0)
  ) %>%
  .$newpred

rmse_mug <- RMSE(pred, test_set$rating)
rmse_mug
```
Upon completing and running the code, it can be observed that the RMSE for the model with the added genre effect is `r round(rmse_mug,4)`.

Below are the RMSEs of all the models so far:

```{r echo=FALSE}
data.frame(method = "Just the average", RMSE = rmse_average) %>%
  bind_rows(data.frame(method = "Movie Effect Model", RMSE = rmse_m)) %>%
  bind_rows(data.frame(method = "Movie + User Effect Model", RMSE = rmse_mu)) %>%
  bind_rows(data.frame(method = "Movie + User + Genre Effect Model", RMSE = rmse_mug))
```

The RMSE for Movie + User + Genre Effect Model is higher than our previous model. This may be due to some users having only rated a certain genre a few times. These would result in noisy estimates that we should not trust, and may result in overfitting. Thus, we perform regularization with our current model. During the process, we also include the movie effect and user effect.

To find lambda for regularization, we divide again the train_set into two for cross validation, namely: train_set_2 and test_set_2. They are 90% and 10% of the train_set, respectively. We get them using the following code:
```{r echo=TRUE, eval=F}
test_index_2 <- createDataPartition(train_set$rating, times = 1, p = 0.1, list = F)
train_set_2 <- train_set[-test_index_2,]
temp2 <- train_set[test_index_2,]
test_set_2 <- temp2 %>%
  semi_join(train_set_2, by = 'movieId') %>%
  semi_join(train_set_2, by = 'userId')
```

We also get a new average rating.
```{r echo=TRUE, eval=F}
mu2 <- mean(train_set_2$rating)
mu2
```

Below is a sample of the code on how the penalty terms lambda was chosen
```{r echo=TRUE, eval = F}
lambdas <- seq(0,30)

rmses <- sapply(lambdas, function(l){
movie_effect <- train_set_2 %>% 
  group_by(movieId) %>% 
  summarize(b_i = sum(rating-mu)/(n() + l))

pred <- test_set_2 %>%
  left_join(movie_effect, by='movieId') %>%
  mutate(pred = mu + b_i) %>%
  .$pred

return(RMSE(pred, test_set_2$rating))
})
```
The lambda with the lowest RMSE is chosen. That procedure is done for each effect/bias added to the model, one by one.

After getting the lambda for each effect which gets the lowest RMSE for test_set_2, we use those lambdas for our current model. We get the new bias/effect values where we apply regularization:
```{r include=FALSE}

mu <- mean(train_set$rating)

movie_effect <- train_set %>% 
  group_by(movieId) %>% 
  summarize(b_i = sum(rating-mu)/(n() + 1.75))

user_effect <- train_set %>% 
  left_join(movie_effect, by = 'movieId') %>%
  group_by(userId) %>% 
  mutate(pred = mu + b_i) %>%
  summarize(b_u = sum(rating-pred)/(n() + 5))

drama_effect <- train_set %>% 
  left_join(movie_effect, by = 'movieId') %>%
  left_join(user_effect, by='userId') %>%
  mutate(pred = mu + b_i + b_u) %>%
  mutate(drama = ifelse(str_detect(genres, "Drama"), 1, 0)) %>%
  filter(drama == 1) %>%
  group_by(userId) %>%
  summarize(b_drama = sum(rating - pred)/(n() + 27))

comedy_effect <- train_set %>% 
  left_join(movie_effect, by = 'movieId') %>%
  left_join(user_effect, by='userId') %>%
  left_join(drama_effect, by='userId') %>%
  mutate(pred = mu + b_i + b_u +
           ifelse(str_detect(genres, "Drama") & !is.na(b_drama), b_drama, 0)
  ) %>%
  mutate(comedy = ifelse(str_detect(genres, "Comedy"), 1, 0)) %>%
  filter(comedy == 1) %>%
  group_by(userId) %>%
  summarize(b_comedy = sum(rating - pred)/(n() + 32))

action_effect <- train_set %>% 
  left_join(movie_effect, by = 'movieId') %>%
  left_join(user_effect, by='userId') %>%
  left_join(drama_effect, by='userId') %>%
  left_join(comedy_effect, by='userId') %>%
  mutate(pred = mu + b_i + b_u +
           ifelse(str_detect(genres, "Drama") & !is.na(b_drama), b_drama, 0) +
           ifelse(str_detect(genres, "Comedy") & !is.na(b_comedy), b_comedy, 0)
  ) %>%
  mutate(action = ifelse(str_detect(genres, "Action"), 1, 0)) %>%
  filter(action == 1) %>%
  group_by(userId) %>%
  summarize(b_action = sum(rating - pred)/(n() + 11))

thriller_effect <- train_set %>% 
  left_join(movie_effect, by = 'movieId') %>%
  left_join(user_effect, by='userId') %>%
  left_join(drama_effect, by='userId') %>%
  left_join(comedy_effect, by='userId') %>%
  left_join(action_effect, by='userId') %>%
  mutate(pred = mu + b_i + b_u +
           ifelse(str_detect(genres, "Drama") & !is.na(b_drama), b_drama, 0) +
           ifelse(str_detect(genres, "Comedy") & !is.na(b_comedy), b_comedy, 0) +
           ifelse(str_detect(genres, "Action") & !is.na(b_action), b_action, 0)
  ) %>%
  mutate(thriller = ifelse(str_detect(genres, "Thriller"), 1, 0)) %>%
  filter(thriller == 1) %>%
  group_by(userId) %>%
  summarize(b_thriller = sum(rating - pred)/(n() + 36))

adventure_effect <- train_set %>% 
  left_join(movie_effect, by = 'movieId') %>%
  left_join(user_effect, by='userId') %>%
  left_join(drama_effect, by='userId') %>%
  left_join(comedy_effect, by='userId') %>%
  left_join(action_effect, by='userId') %>%
  left_join(thriller_effect, by='userId') %>%
  mutate(pred = mu + b_i + b_u +
           ifelse(str_detect(genres, "Drama") & !is.na(b_drama), b_drama, 0) +
           ifelse(str_detect(genres, "Comedy") & !is.na(b_comedy), b_comedy, 0) +
           ifelse(str_detect(genres, "Action") & !is.na(b_action), b_action, 0) +
           ifelse(str_detect(genres, "Thriller") & !is.na(b_thriller), b_thriller, 0)
  ) %>%
  mutate(adventure = ifelse(str_detect(genres, "Adventure"), 1, 0)) %>%
  filter(adventure == 1) %>%
  group_by(userId) %>%
  summarize(b_adventure = sum(rating - pred)/(n() + 27))

romance_effect <- train_set %>% 
  left_join(movie_effect, by = 'movieId') %>%
  left_join(user_effect, by='userId') %>%
  left_join(drama_effect, by='userId') %>%
  left_join(comedy_effect, by='userId') %>%
  left_join(action_effect, by='userId') %>%
  left_join(thriller_effect, by='userId') %>%
  left_join(adventure_effect, by='userId') %>%
  mutate(pred = mu + b_i + b_u +
           ifelse(str_detect(genres, "Drama") & !is.na(b_drama), b_drama, 0) +
           ifelse(str_detect(genres, "Comedy") & !is.na(b_comedy), b_comedy, 0) +
           ifelse(str_detect(genres, "Action") & !is.na(b_action), b_action, 0) +
           ifelse(str_detect(genres, "Thriller") & !is.na(b_thriller), b_thriller, 0) +
           ifelse(str_detect(genres, "Adventure") & !is.na(b_adventure), b_adventure, 0)
  ) %>%
  mutate(romance = ifelse(str_detect(genres, "Romance"), 1, 0)) %>%
  filter(romance == 1) %>%
  group_by(userId) %>%
  summarize(b_romance = sum(rating - pred)/(n() + 31))

sci_effect <- train_set %>% 
  left_join(movie_effect, by = 'movieId') %>%
  left_join(user_effect, by='userId') %>%
  left_join(drama_effect, by='userId') %>%
  left_join(comedy_effect, by='userId') %>%
  left_join(action_effect, by='userId') %>%
  left_join(thriller_effect, by='userId') %>%
  left_join(adventure_effect, by='userId') %>%
  left_join(romance_effect, by='userId') %>%
  mutate(pred = mu + b_i + b_u +
           ifelse(str_detect(genres, "Drama") & !is.na(b_drama), b_drama, 0) +
           ifelse(str_detect(genres, "Comedy") & !is.na(b_comedy), b_comedy, 0) +
           ifelse(str_detect(genres, "Action") & !is.na(b_action), b_action, 0) +
           ifelse(str_detect(genres, "Thriller") & !is.na(b_thriller), b_thriller, 0) +
           ifelse(str_detect(genres, "Adventure") & !is.na(b_adventure), b_adventure, 0) +
           ifelse(str_detect(genres, "Romance") & !is.na(b_romance), b_romance, 0)
  ) %>%
  mutate(sci = ifelse(str_detect(genres, "Sci"), 1, 0)) %>%
  filter(sci == 1) %>%
  group_by(userId) %>%
  summarize(b_sci = sum(rating - pred)/(n() + 25))

crime_effect <- train_set %>% 
  left_join(movie_effect, by = 'movieId') %>%
  left_join(user_effect, by='userId') %>%
  left_join(drama_effect, by='userId') %>%
  left_join(comedy_effect, by='userId') %>%
  left_join(action_effect, by='userId') %>%
  left_join(thriller_effect, by='userId') %>%
  left_join(adventure_effect, by='userId') %>%
  left_join(romance_effect, by='userId') %>%
  left_join(sci_effect, by='userId') %>%
  mutate(pred = mu + b_i + b_u +
           ifelse(str_detect(genres, "Drama") & !is.na(b_drama), b_drama, 0) +
           ifelse(str_detect(genres, "Comedy") & !is.na(b_comedy), b_comedy, 0) +
           ifelse(str_detect(genres, "Action") & !is.na(b_action), b_action, 0) +
           ifelse(str_detect(genres, "Thriller") & !is.na(b_thriller), b_thriller, 0) +
           ifelse(str_detect(genres, "Adventure") & !is.na(b_adventure), b_adventure, 0) +
           ifelse(str_detect(genres, "Romance") & !is.na(b_romance), b_romance, 0) +
           ifelse(str_detect(genres, "Sci") & !is.na(b_sci), b_sci, 0)
  ) %>%
  mutate(crime = ifelse(str_detect(genres, "Crime"), 1, 0)) %>%
  filter(crime == 1) %>%
  group_by(userId) %>%
  summarize(b_crime = sum(rating - pred)/(n() + 25))

fantasy_effect <- train_set %>% 
  left_join(movie_effect, by = 'movieId') %>%
  left_join(user_effect, by='userId') %>%
  left_join(drama_effect, by='userId') %>%
  left_join(comedy_effect, by='userId') %>%
  left_join(action_effect, by='userId') %>%
  left_join(thriller_effect, by='userId') %>%
  left_join(adventure_effect, by='userId') %>%
  left_join(romance_effect, by='userId') %>%
  left_join(sci_effect, by='userId') %>%
  left_join(crime_effect, by='userId') %>%
  mutate(pred = mu + b_i + b_u +
           ifelse(str_detect(genres, "Drama") & !is.na(b_drama), b_drama, 0) +
           ifelse(str_detect(genres, "Comedy") & !is.na(b_comedy), b_comedy, 0) +
           ifelse(str_detect(genres, "Action") & !is.na(b_action), b_action, 0) +
           ifelse(str_detect(genres, "Thriller") & !is.na(b_thriller), b_thriller, 0) +
           ifelse(str_detect(genres, "Adventure") & !is.na(b_adventure), b_adventure, 0) +
           ifelse(str_detect(genres, "Romance") & !is.na(b_romance), b_romance, 0) +
           ifelse(str_detect(genres, "Sci") & !is.na(b_sci), b_sci, 0) +
           ifelse(str_detect(genres, "Crime") & !is.na(b_crime), b_crime, 0)
  ) %>%
  mutate(fantasy = ifelse(str_detect(genres, "Fantasy"), 1, 0)) %>%
  filter(fantasy == 1) %>%
  group_by(userId) %>%
  summarize(b_fantasy = sum(rating - pred)/(n() + 25))

children_effect <- train_set %>% 
  left_join(movie_effect, by = 'movieId') %>%
  left_join(user_effect, by='userId') %>%
  left_join(drama_effect, by='userId') %>%
  left_join(comedy_effect, by='userId') %>%
  left_join(action_effect, by='userId') %>%
  left_join(thriller_effect, by='userId') %>%
  left_join(adventure_effect, by='userId') %>%
  left_join(romance_effect, by='userId') %>%
  left_join(sci_effect, by='userId') %>%
  left_join(crime_effect, by='userId') %>%
  left_join(fantasy_effect, by='userId') %>%
  mutate(pred = mu + b_i + b_u +
           ifelse(str_detect(genres, "Drama") & !is.na(b_drama), b_drama, 0) +
           ifelse(str_detect(genres, "Comedy") & !is.na(b_comedy), b_comedy, 0) +
           ifelse(str_detect(genres, "Action") & !is.na(b_action), b_action, 0) +
           ifelse(str_detect(genres, "Thriller") & !is.na(b_thriller), b_thriller, 0) +
           ifelse(str_detect(genres, "Adventure") & !is.na(b_adventure), b_adventure, 0) +
           ifelse(str_detect(genres, "Romance") & !is.na(b_romance), b_romance, 0) +
           ifelse(str_detect(genres, "Sci") & !is.na(b_sci), b_sci, 0) +
           ifelse(str_detect(genres, "Crime") & !is.na(b_crime), b_crime, 0) +
           ifelse(str_detect(genres, "Fantasy") & !is.na(b_fantasy), b_fantasy, 0)
  ) %>%
  mutate(children = ifelse(str_detect(genres, "Children"), 1, 0)) %>%
  filter(children == 1) %>%
  group_by(userId) %>%
  summarize(b_children = sum(rating - pred)/(n() + 7))

horror_effect <- train_set %>% 
  left_join(movie_effect, by = 'movieId') %>%
  left_join(user_effect, by='userId') %>%
  left_join(drama_effect, by='userId') %>%
  left_join(comedy_effect, by='userId') %>%
  left_join(action_effect, by='userId') %>%
  left_join(thriller_effect, by='userId') %>%
  left_join(adventure_effect, by='userId') %>%
  left_join(romance_effect, by='userId') %>%
  left_join(sci_effect, by='userId') %>%
  left_join(crime_effect, by='userId') %>%
  left_join(fantasy_effect, by='userId') %>%
  left_join(children_effect, by='userId') %>%
  mutate(pred = mu + b_i + b_u +
           ifelse(str_detect(genres, "Drama") & !is.na(b_drama), b_drama, 0) +
           ifelse(str_detect(genres, "Comedy") & !is.na(b_comedy), b_comedy, 0) +
           ifelse(str_detect(genres, "Action") & !is.na(b_action), b_action, 0) +
           ifelse(str_detect(genres, "Thriller") & !is.na(b_thriller), b_thriller, 0) +
           ifelse(str_detect(genres, "Adventure") & !is.na(b_adventure), b_adventure, 0) +
           ifelse(str_detect(genres, "Romance") & !is.na(b_romance), b_romance, 0) +
           ifelse(str_detect(genres, "Sci") & !is.na(b_sci), b_sci, 0) +
           ifelse(str_detect(genres, "Crime") & !is.na(b_crime), b_crime, 0) +
           ifelse(str_detect(genres, "Fantasy") & !is.na(b_fantasy), b_fantasy, 0) +
           ifelse(str_detect(genres, "Children") & !is.na(b_children), b_children, 0)
  ) %>%
  mutate(horror = ifelse(str_detect(genres, "Horror"), 1, 0)) %>%
  filter(horror == 1) %>%
  group_by(userId) %>%
  summarize(b_horror = sum(rating - pred)/(n() + 9))

mystery_effect <- train_set %>% 
  left_join(movie_effect, by = 'movieId') %>%
  left_join(user_effect, by='userId') %>%
  left_join(drama_effect, by='userId') %>%
  left_join(comedy_effect, by='userId') %>%
  left_join(action_effect, by='userId') %>%
  left_join(thriller_effect, by='userId') %>%
  left_join(adventure_effect, by='userId') %>%
  left_join(romance_effect, by='userId') %>%
  left_join(sci_effect, by='userId') %>%
  left_join(crime_effect, by='userId') %>%
  left_join(fantasy_effect, by='userId') %>%
  left_join(children_effect, by='userId') %>%
  left_join(horror_effect, by='userId') %>%
  mutate(pred = mu + b_i + b_u +
           ifelse(str_detect(genres, "Drama") & !is.na(b_drama), b_drama, 0) +
           ifelse(str_detect(genres, "Comedy") & !is.na(b_comedy), b_comedy, 0) +
           ifelse(str_detect(genres, "Action") & !is.na(b_action), b_action, 0) +
           ifelse(str_detect(genres, "Thriller") & !is.na(b_thriller), b_thriller, 0) +
           ifelse(str_detect(genres, "Adventure") & !is.na(b_adventure), b_adventure, 0) +
           ifelse(str_detect(genres, "Romance") & !is.na(b_romance), b_romance, 0) +
           ifelse(str_detect(genres, "Sci") & !is.na(b_sci), b_sci, 0) +
           ifelse(str_detect(genres, "Crime") & !is.na(b_crime), b_crime, 0) +
           ifelse(str_detect(genres, "Fantasy") & !is.na(b_fantasy), b_fantasy, 0) +
           ifelse(str_detect(genres, "Children") & !is.na(b_children), b_children, 0) +
           ifelse(str_detect(genres, "Horror") & !is.na(b_horror), b_horror, 0)
  ) %>%
  mutate(mystery = ifelse(str_detect(genres, "Mystery"), 1, 0)) %>%
  filter(mystery == 1) %>%
  group_by(userId) %>%
  summarize(b_mystery = sum(rating - pred)/(n() + 62))

war_effect <- train_set %>% 
  left_join(movie_effect, by = 'movieId') %>%
  left_join(user_effect, by='userId') %>%
  left_join(drama_effect, by='userId') %>%
  left_join(comedy_effect, by='userId') %>%
  left_join(action_effect, by='userId') %>%
  left_join(thriller_effect, by='userId') %>%
  left_join(adventure_effect, by='userId') %>%
  left_join(romance_effect, by='userId') %>%
  left_join(sci_effect, by='userId') %>%
  left_join(crime_effect, by='userId') %>%
  left_join(fantasy_effect, by='userId') %>%
  left_join(children_effect, by='userId') %>%
  left_join(horror_effect, by='userId') %>%
  left_join(mystery_effect, by='userId') %>%
  mutate(pred = mu + b_i + b_u +
           ifelse(str_detect(genres, "Drama") & !is.na(b_drama), b_drama, 0) +
           ifelse(str_detect(genres, "Comedy") & !is.na(b_comedy), b_comedy, 0) +
           ifelse(str_detect(genres, "Action") & !is.na(b_action), b_action, 0) +
           ifelse(str_detect(genres, "Thriller") & !is.na(b_thriller), b_thriller, 0) +
           ifelse(str_detect(genres, "Adventure") & !is.na(b_adventure), b_adventure, 0) +
           ifelse(str_detect(genres, "Romance") & !is.na(b_romance), b_romance, 0) +
           ifelse(str_detect(genres, "Sci") & !is.na(b_sci), b_sci, 0) +
           ifelse(str_detect(genres, "Crime") & !is.na(b_crime), b_crime, 0) +
           ifelse(str_detect(genres, "Fantasy") & !is.na(b_fantasy), b_fantasy, 0) +
           ifelse(str_detect(genres, "Children") & !is.na(b_children), b_children, 0) +
           ifelse(str_detect(genres, "Horror") & !is.na(b_horror), b_horror, 0) +
           ifelse(str_detect(genres, "Mystery") & !is.na(b_mystery), b_mystery, 0)
  ) %>%
  mutate(war = ifelse(str_detect(genres, "War"), 1, 0)) %>%
  filter(war == 1) %>%
  group_by(userId) %>%
  summarize(b_war = sum(rating - pred)/(n() + 28))

animation_effect <- train_set %>% 
  left_join(movie_effect, by = 'movieId') %>%
  left_join(user_effect, by='userId') %>%
  left_join(drama_effect, by='userId') %>%
  left_join(comedy_effect, by='userId') %>%
  left_join(action_effect, by='userId') %>%
  left_join(thriller_effect, by='userId') %>%
  left_join(adventure_effect, by='userId') %>%
  left_join(romance_effect, by='userId') %>%
  left_join(sci_effect, by='userId') %>%
  left_join(crime_effect, by='userId') %>%
  left_join(fantasy_effect, by='userId') %>%
  left_join(children_effect, by='userId') %>%
  left_join(horror_effect, by='userId') %>%
  left_join(mystery_effect, by='userId') %>%
  left_join(war_effect, by='userId') %>%
  mutate(pred = mu + b_i + b_u +
           ifelse(str_detect(genres, "Drama") & !is.na(b_drama), b_drama, 0) +
           ifelse(str_detect(genres, "Comedy") & !is.na(b_comedy), b_comedy, 0) +
           ifelse(str_detect(genres, "Action") & !is.na(b_action), b_action, 0) +
           ifelse(str_detect(genres, "Thriller") & !is.na(b_thriller), b_thriller, 0) +
           ifelse(str_detect(genres, "Adventure") & !is.na(b_adventure), b_adventure, 0) +
           ifelse(str_detect(genres, "Romance") & !is.na(b_romance), b_romance, 0) +
           ifelse(str_detect(genres, "Sci") & !is.na(b_sci), b_sci, 0) +
           ifelse(str_detect(genres, "Crime") & !is.na(b_crime), b_crime, 0) +
           ifelse(str_detect(genres, "Fantasy") & !is.na(b_fantasy), b_fantasy, 0) +
           ifelse(str_detect(genres, "Children") & !is.na(b_children), b_children, 0) +
           ifelse(str_detect(genres, "Horror") & !is.na(b_horror), b_horror, 0) +
           ifelse(str_detect(genres, "Mystery") & !is.na(b_mystery), b_mystery, 0) +
           ifelse(str_detect(genres, "War") & !is.na(b_war), b_war, 0)
  ) %>%
  mutate(animation = ifelse(str_detect(genres, "Animation"), 1, 0)) %>%
  filter(animation == 1) %>%
  group_by(userId) %>%
  summarize(b_animation = sum(rating - pred)/(n() + 11))

musical_effect <- train_set %>% 
  left_join(movie_effect, by = 'movieId') %>%
  left_join(user_effect, by='userId') %>%
  left_join(drama_effect, by='userId') %>%
  left_join(comedy_effect, by='userId') %>%
  left_join(action_effect, by='userId') %>%
  left_join(thriller_effect, by='userId') %>%
  left_join(adventure_effect, by='userId') %>%
  left_join(romance_effect, by='userId') %>%
  left_join(sci_effect, by='userId') %>%
  left_join(crime_effect, by='userId') %>%
  left_join(fantasy_effect, by='userId') %>%
  left_join(children_effect, by='userId') %>%
  left_join(horror_effect, by='userId') %>%
  left_join(mystery_effect, by='userId') %>%
  left_join(war_effect, by='userId') %>%
  left_join(animation_effect, by='userId') %>%
  mutate(pred = mu + b_i + b_u +
           ifelse(str_detect(genres, "Drama") & !is.na(b_drama), b_drama, 0) +
           ifelse(str_detect(genres, "Comedy") & !is.na(b_comedy), b_comedy, 0) +
           ifelse(str_detect(genres, "Action") & !is.na(b_action), b_action, 0) +
           ifelse(str_detect(genres, "Thriller") & !is.na(b_thriller), b_thriller, 0) +
           ifelse(str_detect(genres, "Adventure") & !is.na(b_adventure), b_adventure, 0) +
           ifelse(str_detect(genres, "Romance") & !is.na(b_romance), b_romance, 0) +
           ifelse(str_detect(genres, "Sci") & !is.na(b_sci), b_sci, 0) +
           ifelse(str_detect(genres, "Crime") & !is.na(b_crime), b_crime, 0) +
           ifelse(str_detect(genres, "Fantasy") & !is.na(b_fantasy), b_fantasy, 0) +
           ifelse(str_detect(genres, "Children") & !is.na(b_children), b_children, 0) +
           ifelse(str_detect(genres, "Horror") & !is.na(b_horror), b_horror, 0) +
           ifelse(str_detect(genres, "Mystery") & !is.na(b_mystery), b_mystery, 0) +
           ifelse(str_detect(genres, "War") & !is.na(b_war), b_war, 0) +
           ifelse(str_detect(genres, "Animation") & !is.na(b_animation), b_animation, 0)
  ) %>%
  mutate(musical = ifelse(str_detect(genres, "Musical"), 1, 0)) %>%
  filter(musical == 1) %>%
  group_by(userId) %>%
  summarize(b_musical = sum(rating - pred)/(n() + 16))

western_effect <- train_set %>% 
  left_join(movie_effect, by = 'movieId') %>%
  left_join(user_effect, by='userId') %>%
  left_join(drama_effect, by='userId') %>%
  left_join(comedy_effect, by='userId') %>%
  left_join(action_effect, by='userId') %>%
  left_join(thriller_effect, by='userId') %>%
  left_join(adventure_effect, by='userId') %>%
  left_join(romance_effect, by='userId') %>%
  left_join(sci_effect, by='userId') %>%
  left_join(crime_effect, by='userId') %>%
  left_join(fantasy_effect, by='userId') %>%
  left_join(children_effect, by='userId') %>%
  left_join(horror_effect, by='userId') %>%
  left_join(mystery_effect, by='userId') %>%
  left_join(war_effect, by='userId') %>%
  left_join(animation_effect, by='userId') %>%
  left_join(musical_effect, by='userId') %>%
  mutate(pred = mu + b_i + b_u +
           ifelse(str_detect(genres, "Drama") & !is.na(b_drama), b_drama, 0) +
           ifelse(str_detect(genres, "Comedy") & !is.na(b_comedy), b_comedy, 0) +
           ifelse(str_detect(genres, "Action") & !is.na(b_action), b_action, 0) +
           ifelse(str_detect(genres, "Thriller") & !is.na(b_thriller), b_thriller, 0) +
           ifelse(str_detect(genres, "Adventure") & !is.na(b_adventure), b_adventure, 0) +
           ifelse(str_detect(genres, "Romance") & !is.na(b_romance), b_romance, 0) +
           ifelse(str_detect(genres, "Sci") & !is.na(b_sci), b_sci, 0) +
           ifelse(str_detect(genres, "Crime") & !is.na(b_crime), b_crime, 0) +
           ifelse(str_detect(genres, "Fantasy") & !is.na(b_fantasy), b_fantasy, 0) +
           ifelse(str_detect(genres, "Children") & !is.na(b_children), b_children, 0) +
           ifelse(str_detect(genres, "Horror") & !is.na(b_horror), b_horror, 0) +
           ifelse(str_detect(genres, "Mystery") & !is.na(b_mystery), b_mystery, 0) +
           ifelse(str_detect(genres, "War") & !is.na(b_war), b_war, 0) +
           ifelse(str_detect(genres, "Animation") & !is.na(b_animation), b_animation, 0) +
           ifelse(str_detect(genres, "Musical") & !is.na(b_musical), b_musical, 0)
  ) %>%
  mutate(western = ifelse(str_detect(genres, "Western"), 1, 0)) %>%
  filter(western == 1) %>%
  group_by(userId) %>%
  summarize(b_western = sum(rating - pred)/(n() + 20))

film_effect <- train_set %>% 
  left_join(movie_effect, by = 'movieId') %>%
  left_join(user_effect, by='userId') %>%
  left_join(drama_effect, by='userId') %>%
  left_join(comedy_effect, by='userId') %>%
  left_join(action_effect, by='userId') %>%
  left_join(thriller_effect, by='userId') %>%
  left_join(adventure_effect, by='userId') %>%
  left_join(romance_effect, by='userId') %>%
  left_join(sci_effect, by='userId') %>%
  left_join(crime_effect, by='userId') %>%
  left_join(fantasy_effect, by='userId') %>%
  left_join(children_effect, by='userId') %>%
  left_join(horror_effect, by='userId') %>%
  left_join(mystery_effect, by='userId') %>%
  left_join(war_effect, by='userId') %>%
  left_join(animation_effect, by='userId') %>%
  left_join(musical_effect, by='userId') %>%
  left_join(western_effect, by='userId') %>%
  mutate(pred = mu + b_i + b_u +
           ifelse(str_detect(genres, "Drama") & !is.na(b_drama), b_drama, 0) +
           ifelse(str_detect(genres, "Comedy") & !is.na(b_comedy), b_comedy, 0) +
           ifelse(str_detect(genres, "Action") & !is.na(b_action), b_action, 0) +
           ifelse(str_detect(genres, "Thriller") & !is.na(b_thriller), b_thriller, 0) +
           ifelse(str_detect(genres, "Adventure") & !is.na(b_adventure), b_adventure, 0) +
           ifelse(str_detect(genres, "Romance") & !is.na(b_romance), b_romance, 0) +
           ifelse(str_detect(genres, "Sci") & !is.na(b_sci), b_sci, 0) +
           ifelse(str_detect(genres, "Crime") & !is.na(b_crime), b_crime, 0) +
           ifelse(str_detect(genres, "Fantasy") & !is.na(b_fantasy), b_fantasy, 0) +
           ifelse(str_detect(genres, "Children") & !is.na(b_children), b_children, 0) +
           ifelse(str_detect(genres, "Horror") & !is.na(b_horror), b_horror, 0) +
           ifelse(str_detect(genres, "Mystery") & !is.na(b_mystery), b_mystery, 0) +
           ifelse(str_detect(genres, "War") & !is.na(b_war), b_war, 0) +
           ifelse(str_detect(genres, "Animation") & !is.na(b_animation), b_animation, 0) +
           ifelse(str_detect(genres, "Musical") & !is.na(b_musical), b_musical, 0) +
           ifelse(str_detect(genres, "Western") & !is.na(b_western), b_western, 0)
  ) %>%
  mutate(film = ifelse(str_detect(genres, "Film"), 1, 0)) %>%
  filter(film == 1) %>%
  group_by(userId) %>%
  summarize(b_film = sum(rating - pred)/(n() + 9))

documentary_effect <- train_set %>% 
  left_join(movie_effect, by = 'movieId') %>%
  left_join(user_effect, by='userId') %>%
  left_join(drama_effect, by='userId') %>%
  left_join(comedy_effect, by='userId') %>%
  left_join(action_effect, by='userId') %>%
  left_join(thriller_effect, by='userId') %>%
  left_join(adventure_effect, by='userId') %>%
  left_join(romance_effect, by='userId') %>%
  left_join(sci_effect, by='userId') %>%
  left_join(crime_effect, by='userId') %>%
  left_join(fantasy_effect, by='userId') %>%
  left_join(children_effect, by='userId') %>%
  left_join(horror_effect, by='userId') %>%
  left_join(mystery_effect, by='userId') %>%
  left_join(war_effect, by='userId') %>%
  left_join(animation_effect, by='userId') %>%
  left_join(musical_effect, by='userId') %>%
  left_join(western_effect, by='userId') %>%
  left_join(film_effect, by='userId') %>%
  mutate(pred = mu + b_i + b_u +
           ifelse(str_detect(genres, "Drama") & !is.na(b_drama), b_drama, 0) +
           ifelse(str_detect(genres, "Comedy") & !is.na(b_comedy), b_comedy, 0) +
           ifelse(str_detect(genres, "Action") & !is.na(b_action), b_action, 0) +
           ifelse(str_detect(genres, "Thriller") & !is.na(b_thriller), b_thriller, 0) +
           ifelse(str_detect(genres, "Adventure") & !is.na(b_adventure), b_adventure, 0) +
           ifelse(str_detect(genres, "Romance") & !is.na(b_romance), b_romance, 0) +
           ifelse(str_detect(genres, "Sci") & !is.na(b_sci), b_sci, 0) +
           ifelse(str_detect(genres, "Crime") & !is.na(b_crime), b_crime, 0) +
           ifelse(str_detect(genres, "Fantasy") & !is.na(b_fantasy), b_fantasy, 0) +
           ifelse(str_detect(genres, "Children") & !is.na(b_children), b_children, 0) +
           ifelse(str_detect(genres, "Horror") & !is.na(b_horror), b_horror, 0) +
           ifelse(str_detect(genres, "Mystery") & !is.na(b_mystery), b_mystery, 0) +
           ifelse(str_detect(genres, "War") & !is.na(b_war), b_war, 0) +
           ifelse(str_detect(genres, "Animation") & !is.na(b_animation), b_animation, 0) +
           ifelse(str_detect(genres, "Musical") & !is.na(b_musical), b_musical, 0) +
           ifelse(str_detect(genres, "Western") & !is.na(b_western), b_western, 0) +
           ifelse(str_detect(genres, "Film") & !is.na(b_film), b_film, 0)
  ) %>%
  mutate(documentary = ifelse(str_detect(genres, "Documentary"), 1, 0)) %>%
  filter(documentary == 1) %>%
  group_by(userId) %>%
  summarize(b_documentary = sum(rating - pred)/(n() + 4))

imax_effect <- train_set %>% 
  left_join(movie_effect, by = 'movieId') %>%
  left_join(user_effect, by='userId') %>%
  left_join(drama_effect, by='userId') %>%
  left_join(comedy_effect, by='userId') %>%
  left_join(action_effect, by='userId') %>%
  left_join(thriller_effect, by='userId') %>%
  left_join(adventure_effect, by='userId') %>%
  left_join(romance_effect, by='userId') %>%
  left_join(sci_effect, by='userId') %>%
  left_join(crime_effect, by='userId') %>%
  left_join(fantasy_effect, by='userId') %>%
  left_join(children_effect, by='userId') %>%
  left_join(horror_effect, by='userId') %>%
  left_join(mystery_effect, by='userId') %>%
  left_join(war_effect, by='userId') %>%
  left_join(animation_effect, by='userId') %>%
  left_join(musical_effect, by='userId') %>%
  left_join(western_effect, by='userId') %>%
  left_join(film_effect, by='userId') %>%
  left_join(documentary_effect, by='userId') %>%
  mutate(pred = mu + b_i + b_u +
           ifelse(str_detect(genres, "Drama") & !is.na(b_drama), b_drama, 0) +
           ifelse(str_detect(genres, "Comedy") & !is.na(b_comedy), b_comedy, 0) +
           ifelse(str_detect(genres, "Action") & !is.na(b_action), b_action, 0) +
           ifelse(str_detect(genres, "Thriller") & !is.na(b_thriller), b_thriller, 0) +
           ifelse(str_detect(genres, "Adventure") & !is.na(b_adventure), b_adventure, 0) +
           ifelse(str_detect(genres, "Romance") & !is.na(b_romance), b_romance, 0) +
           ifelse(str_detect(genres, "Sci") & !is.na(b_sci), b_sci, 0) +
           ifelse(str_detect(genres, "Crime") & !is.na(b_crime), b_crime, 0) +
           ifelse(str_detect(genres, "Fantasy") & !is.na(b_fantasy), b_fantasy, 0) +
           ifelse(str_detect(genres, "Children") & !is.na(b_children), b_children, 0) +
           ifelse(str_detect(genres, "Horror") & !is.na(b_horror), b_horror, 0) +
           ifelse(str_detect(genres, "Mystery") & !is.na(b_mystery), b_mystery, 0) +
           ifelse(str_detect(genres, "War") & !is.na(b_war), b_war, 0) +
           ifelse(str_detect(genres, "Animation") & !is.na(b_animation), b_animation, 0) +
           ifelse(str_detect(genres, "Musical") & !is.na(b_musical), b_musical, 0) +
           ifelse(str_detect(genres, "Western") & !is.na(b_western), b_western, 0) +
           ifelse(str_detect(genres, "Film") & !is.na(b_film), b_film, 0) +
           ifelse(str_detect(genres, "Documentary") & !is.na(b_documentary), b_documentary, 0)
  ) %>%
  mutate(imax = ifelse(str_detect(genres, "IMAX"), 1, 0)) %>%
  filter(imax == 1) %>%
  group_by(userId) %>%
  summarize(b_imax = sum(rating - pred)/(n() + 5.5))

```

We find the RMSE for our new model with the following code:
```{r}
pred <- test_set %>% 
  left_join(movie_effect, by = 'movieId') %>%
  left_join(user_effect, by='userId') %>%
  left_join(drama_effect, by='userId') %>%
  left_join(comedy_effect, by='userId') %>%
  left_join(action_effect, by='userId') %>%
  left_join(thriller_effect, by='userId') %>%
  left_join(adventure_effect, by='userId') %>%
  left_join(romance_effect, by='userId') %>%
  left_join(sci_effect, by='userId') %>%
  left_join(crime_effect, by='userId') %>%
  left_join(fantasy_effect, by='userId') %>%
  left_join(children_effect, by='userId') %>%
  left_join(horror_effect, by='userId') %>%
  left_join(mystery_effect, by='userId') %>%
  left_join(war_effect, by='userId') %>%
  left_join(animation_effect, by='userId') %>%
  left_join(musical_effect, by='userId') %>%
  left_join(western_effect, by='userId') %>%
  left_join(film_effect, by='userId') %>%
  left_join(documentary_effect, by='userId') %>%
  left_join(imax_effect, by='userId') %>%
  mutate(pred = mu + b_i + b_u +
           ifelse(str_detect(genres, "Drama") & !is.na(b_drama), b_drama, 0) +
           ifelse(str_detect(genres, "Comedy") & !is.na(b_comedy), b_comedy, 0) +
           ifelse(str_detect(genres, "Action") & !is.na(b_action), b_action, 0) +
           ifelse(str_detect(genres, "Thriller") & !is.na(b_thriller), b_thriller, 0) +
           ifelse(str_detect(genres, "Adventure") & !is.na(b_adventure), b_adventure, 0) +
           ifelse(str_detect(genres, "Romance") & !is.na(b_romance), b_romance, 0) +
           ifelse(str_detect(genres, "Sci") & !is.na(b_sci), b_sci, 0) +
           ifelse(str_detect(genres, "Crime") & !is.na(b_crime), b_crime, 0) +
           ifelse(str_detect(genres, "Fantasy") & !is.na(b_fantasy), b_fantasy, 0) +
           ifelse(str_detect(genres, "Children") & !is.na(b_children), b_children, 0) +
           ifelse(str_detect(genres, "Horror") & !is.na(b_horror), b_horror, 0) +
           ifelse(str_detect(genres, "Mystery") & !is.na(b_mystery), b_mystery, 0) +
           ifelse(str_detect(genres, "War") & !is.na(b_war), b_war, 0) +
           ifelse(str_detect(genres, "Animation") & !is.na(b_animation), b_animation, 0) +
           ifelse(str_detect(genres, "Musical") & !is.na(b_musical), b_musical, 0) +
           ifelse(str_detect(genres, "Western") & !is.na(b_western), b_western, 0) +
           ifelse(str_detect(genres, "Film") & !is.na(b_film), b_film, 0) +
           ifelse(str_detect(genres, "Documentary") & !is.na(b_documentary), 
                  b_documentary, 0) +
           ifelse(str_detect(genres, "IMAX") & !is.na(b_imax), b_imax, 0)
  ) %>%
    .$pred
  
  rmse_Rmug <- RMSE(pred, test_set$rating)
  rmse_Rmug
```


The new model that includes genre effect is now better than the previous models.
```{r echo=FALSE}
data.frame(method = "Just the average", RMSE = rmse_average) %>%
  bind_rows(data.frame(method = "Movie Effect Model", RMSE = rmse_m)) %>%
  bind_rows(data.frame(method = "Movie + User Effect Model", RMSE = rmse_mu)) %>%
  bind_rows(data.frame(method = "Movie + User + Genre Effect Model", RMSE = rmse_mug)) %>%
  bind_rows(data.frame(method = "Regularized Movie-User-Genre Effect Model", RMSE = rmse_Rmug))
```


## 4. Movie release year effect
For the last effect, before movie release year effect was chosen, three potential biases were tested. First was the timestamp of the rating, second was the age of the movie during the time of rating, and lastly the movie release year. 


```{r include=FALSE}
#Below is the code for the model so far:
mmug_table <- train_set %>% 
  left_join(movie_effect, by = 'movieId') %>%
  left_join(user_effect, by='userId') %>%
  left_join(drama_effect, by='userId') %>%
  left_join(comedy_effect, by='userId') %>%
  left_join(action_effect, by='userId') %>%
  left_join(thriller_effect, by='userId') %>%
  left_join(adventure_effect, by='userId') %>%
  left_join(romance_effect, by='userId') %>%
  left_join(sci_effect, by='userId') %>%
  left_join(crime_effect, by='userId') %>%
  left_join(fantasy_effect, by='userId') %>%
  left_join(children_effect, by='userId') %>%
  left_join(horror_effect, by='userId') %>%
  left_join(mystery_effect, by='userId') %>%
  left_join(war_effect, by='userId') %>%
  left_join(animation_effect, by='userId') %>%
  left_join(musical_effect, by='userId') %>%
  left_join(western_effect, by='userId') %>%
  left_join(film_effect, by='userId') %>%
  left_join(documentary_effect, by='userId') %>%
  left_join(imax_effect, by='userId') %>%
  mutate(pred = mu + b_i + b_u +
           ifelse(str_detect(genres, "Drama") & !is.na(b_drama), b_drama, 0) +
           ifelse(str_detect(genres, "Comedy") & !is.na(b_comedy), b_comedy, 0) +
           ifelse(str_detect(genres, "Action") & !is.na(b_action), b_action, 0) +
           ifelse(str_detect(genres, "Thriller") & !is.na(b_thriller), b_thriller, 0) +
           ifelse(str_detect(genres, "Adventure") & !is.na(b_adventure), b_adventure, 0) +
           ifelse(str_detect(genres, "Romance") & !is.na(b_romance), b_romance, 0) +
           ifelse(str_detect(genres, "Sci") & !is.na(b_sci), b_sci, 0) +
           ifelse(str_detect(genres, "Crime") & !is.na(b_crime), b_crime, 0) +
           ifelse(str_detect(genres, "Fantasy") & !is.na(b_fantasy), b_fantasy, 0) +
           ifelse(str_detect(genres, "Children") & !is.na(b_children), b_children, 0) +
           ifelse(str_detect(genres, "Horror") & !is.na(b_horror), b_horror, 0) +
           ifelse(str_detect(genres, "Mystery") & !is.na(b_mystery), b_mystery, 0) +
           ifelse(str_detect(genres, "War") & !is.na(b_war), b_war, 0) +
           ifelse(str_detect(genres, "Animation") & !is.na(b_animation), b_animation, 0) +
           ifelse(str_detect(genres, "Musical") & !is.na(b_musical), b_musical, 0) +
           ifelse(str_detect(genres, "Western") & !is.na(b_western), b_western, 0) +
           ifelse(str_detect(genres, "Film") & !is.na(b_film), b_film, 0) +
           ifelse(str_detect(genres, "Documentary") & !is.na(b_documentary), b_documentary, 0) +
           ifelse(str_detect(genres, "IMAX") & !is.na(b_imax), b_imax, 0)
  )
```

Below we compare the three time related potential biases for the model. 

```{r visualize_comparetime, echo=FALSE}
library(lubridate)
ratingMonth <- mmug_table %>% 
  select(timestamp, rating, pred) %>%
  mutate(firstdate = min(as.Date.POSIXct(timestamp)),
         timestamp = as.Date.POSIXct(timestamp),
         period = trunc.Date(difftime(timestamp, firstdate, units = "weeks")),
         period2 = interval(firstdate, timestamp, ) %/% months(1)) %>%
  group_by(period2) %>%
  summarize(b_ratingMonth = mean(rating - pred))

fig1 <- ratingMonth %>%
  ggplot(aes(period2, b_ratingMonth)) +
  geom_line() +
  xlab("Month") +
  ggtitle("Timestamp of Rating")

age <- mmug_table %>% 
  mutate(timestamp = year(as.Date.POSIXct(timestamp)),
         movieYear = str_match(title, "(\\d{4})\\)$")[,2],
         ageRated = timestamp - as.numeric(movieYear)) %>%
  filter(ageRated >= 0) %>%
  group_by(ageRated) %>%
  summarize(b_age = mean(rating - pred))

fig2 <- age %>%
  ggplot(aes(ageRated, b_age)) +
  geom_line() +
  xlab("Years") +
  ggtitle("Movie Age During Rating")

movieYear <- mmug_table %>% 
  mutate(timestamp = year(as.Date.POSIXct(timestamp)),
         movieYear = as.numeric(str_match(title, "(\\d{4})\\)$")[,2])) %>%
  group_by(movieYear) %>%
  summarize(b_movieYear = mean(rating - pred), n = n())

fig3 <- movieYear %>%
  ggplot(aes(movieYear, b_movieYear)) +
  geom_line() +
  xlab("Years") +
  ggtitle("Movie Release Year")

library(ggpubr)

annotate_figure(ggarrange(fig1, fig2, fig3), 
                top = text_grob("Comparison of Time Related Potential Biases",
                face = "bold",
                size = 14))
```
Upon inspection of the graphs, firstly, timestamp of rating seems to just be noise with no significant pattern or trend. Movie age during rating looks to have some small pattern but not easily explainable which may just be noise. Ratings however, grouped by movie release year, seems to tell a story. It indicates that movies released around before 1930 seemed to have better ratings. It also tells that movies released around the 90's are not usually received well by the users, while movies in the 2000s are rated higher. Based from this observation, movie release year was chosen to be a potential bias that could improve the current model.

We run a k-nearest neighbor algorithm to get a line that would fit the trend instead of the specific ups and down of the line, which could result in overfitting.  
```{r warning=FALSE}
library(caret)
train_knn <- train(b_movieYear ~ ., method = "knn", 
                   tuneGrid = data.frame(k = seq(1,51,2)), 
                   data = movieYear)

predict_knn <- predict(train_knn, movieYear)
```

Below is a visualization of our fitted line.
```{r}
movieYear %>%
  mutate(knn = predict_knn) %>% 
  rename(mean = b_movieYear) %>%
  gather(mean, knn, key = key,value = value) %>%
  ggplot(aes(movieYear, value, group = key, color = key)) +
  geom_line() +
  xlab("Movie Release Year") +
  ylab("Rating")
```
Below is the code for our final bias.
```{r}
movieYear_effect <- movieYear %>% 
  mutate(knn = predict_knn)
```

The final model would look like the following:
$$
Y_{u,i} = \mu + b_i + b_u + \sum_{k = 1}^K b_{k,u} + f(d_i) + \varepsilon_{u,i}
$$
where $d_i$ is the year the movie was released, with $f$ a function of $d_i$

## 5. Testing the model with test_set
```{r}
pred <- test_set %>% 
  left_join(movie_effect, by = 'movieId') %>%
  left_join(user_effect, by = 'userId') %>%
  left_join(comedy_effect, by = 'userId') %>%
  left_join(drama_effect, by = 'userId') %>%
  left_join(action_effect, by = 'userId') %>%
  left_join(thriller_effect, by = 'userId') %>%
  left_join(adventure_effect, by = 'userId') %>%
  left_join(romance_effect, by = 'userId') %>%
  left_join(sci_effect, by = 'userId') %>%
  left_join(crime_effect, by = 'userId') %>%
  left_join(fantasy_effect, by = 'userId') %>%
  left_join(children_effect, by = 'userId') %>%
  left_join(horror_effect, by = 'userId') %>%
  left_join(mystery_effect, by = 'userId') %>%
  left_join(war_effect, by = 'userId') %>%
  left_join(animation_effect, by = 'userId') %>%
  left_join(musical_effect, by = 'userId') %>%
  left_join(western_effect, by = 'userId') %>%
  left_join(film_effect, by = 'userId') %>%
  left_join(documentary_effect, by = 'userId') %>%
  left_join(imax_effect, by = 'userId') %>%
  mutate(pred = mu + b_i + b_u,
         newpred = pred + 
           ifelse(str_detect(genres, "Comedy") & !is.na(b_comedy), b_comedy, 0) + 
           ifelse(str_detect(genres, "Drama") & !is.na(b_drama), b_drama, 0) +
           ifelse(str_detect(genres, "Action") & !is.na(b_action), b_action, 0) +
           ifelse(str_detect(genres, "Thriller") & !is.na(b_thriller), b_thriller, 0) +
           ifelse(str_detect(genres, "Adventure") & !is.na(b_adventure), b_adventure, 0) +
           ifelse(str_detect(genres, "Romance") & !is.na(b_romance), b_romance, 0) +
           ifelse(str_detect(genres, "Sci") & !is.na(b_sci), b_sci, 0) + 
           ifelse(str_detect(genres, "Crime") & !is.na(b_crime), b_crime, 0) +
           ifelse(str_detect(genres, "Fantasy") & !is.na(b_fantasy), b_fantasy, 0) +
           ifelse(str_detect(genres, "Children") & !is.na(b_children), b_children, 0) +
           ifelse(str_detect(genres, "Horror") & !is.na(b_horror), b_horror, 0) +
           ifelse(str_detect(genres, "Mystery") & !is.na(b_mystery), b_mystery, 0) +
           ifelse(str_detect(genres, "War") & !is.na(b_war), b_war, 0) +
           ifelse(str_detect(genres, "Animation") & !is.na(b_animation), b_animation, 0) +
           ifelse(str_detect(genres, "Musical") & !is.na(b_musical), b_musical, 0) +
           ifelse(str_detect(genres, "Western") & !is.na(b_western), b_western, 0) +
           ifelse(str_detect(genres, "Film") & !is.na(b_film), b_film, 0) +
           ifelse(str_detect(genres, "Documentary") & !is.na(b_documentary), 
                  b_documentary, 0) +
           ifelse(str_detect(genres, "IMAX") & !is.na(b_imax), b_imax, 0)
  ) %>%
  mutate(movieYear = as.numeric(str_match(title, "(\\d{4})\\)$")[,2])) %>%
  left_join(movieYear_effect) %>% 
  mutate(newpred = newpred + knn) %>%
  .$newpred

rmse_Rmug_my <- RMSE(pred, test_set$rating)
rmse_Rmug_my
```
The new model that includes movie year effect is now better than the previous models.
```{r echo=FALSE}
data.frame(method = "Just the average", RMSE = rmse_average) %>%
  bind_rows(data.frame(method = "Movie Effect Model", RMSE = rmse_m)) %>%
  bind_rows(data.frame(method = "Movie + User Effect Model", RMSE = rmse_mu)) %>%
  bind_rows(data.frame(method = "Movie + User + Genre Effect Model", RMSE = rmse_mug)) %>%
  bind_rows(data.frame(method = "Regularized Movie-User-Genre Effect Model", RMSE = rmse_Rmug)) %>%
  bind_rows(data.frame(method = "Movie Year + Regularized Movie-User-Genre Effect Model", RMSE = rmse_Rmug_my))
```


# III. Results  
For the final test of our model, we finally use the validation set.
```{r}
pred <- validation %>% 
  left_join(movie_effect, by = 'movieId') %>%
  left_join(user_effect, by = 'userId') %>%
  left_join(comedy_effect, by = 'userId') %>%
  left_join(drama_effect, by = 'userId') %>%
  left_join(action_effect, by = 'userId') %>%
  left_join(thriller_effect, by = 'userId') %>%
  left_join(adventure_effect, by = 'userId') %>%
  left_join(romance_effect, by = 'userId') %>%
  left_join(sci_effect, by = 'userId') %>%
  left_join(crime_effect, by = 'userId') %>%
  left_join(fantasy_effect, by = 'userId') %>%
  left_join(children_effect, by = 'userId') %>%
  left_join(horror_effect, by = 'userId') %>%
  left_join(mystery_effect, by = 'userId') %>%
  left_join(war_effect, by = 'userId') %>%
  left_join(animation_effect, by = 'userId') %>%
  left_join(musical_effect, by = 'userId') %>%
  left_join(western_effect, by = 'userId') %>%
  left_join(film_effect, by = 'userId') %>%
  left_join(documentary_effect, by = 'userId') %>%
  left_join(imax_effect, by = 'userId') %>%
  mutate(b_u = ifelse(is.na(b_u), 0, b_u),
         b_i = ifelse(is.na(b_i), 0, b_i),
         pred = mu + b_i + b_u,
         newpred = pred + 
           ifelse(str_detect(genres, "Comedy") & !is.na(b_comedy), b_comedy, 0) + 
           ifelse(str_detect(genres, "Drama") & !is.na(b_drama), b_drama, 0) +
           ifelse(str_detect(genres, "Action") & !is.na(b_action), b_action, 0) +
           ifelse(str_detect(genres, "Thriller") & !is.na(b_thriller), b_thriller, 0) +
           ifelse(str_detect(genres, "Adventure") & !is.na(b_adventure), b_adventure, 0) +
           ifelse(str_detect(genres, "Romance") & !is.na(b_romance), b_romance, 0) +
           ifelse(str_detect(genres, "Sci") & !is.na(b_sci), b_sci, 0) + 
           ifelse(str_detect(genres, "Crime") & !is.na(b_crime), b_crime, 0) +
           ifelse(str_detect(genres, "Fantasy") & !is.na(b_fantasy), b_fantasy, 0) +
           ifelse(str_detect(genres, "Children") & !is.na(b_children), b_children, 0) +
           ifelse(str_detect(genres, "Horror") & !is.na(b_horror), b_horror, 0) +
           ifelse(str_detect(genres, "Mystery") & !is.na(b_mystery), b_mystery, 0) +
           ifelse(str_detect(genres, "War") & !is.na(b_war), b_war, 0) +
           ifelse(str_detect(genres, "Animation") & !is.na(b_animation), b_animation, 0) +
           ifelse(str_detect(genres, "Musical") & !is.na(b_musical), b_musical, 0) +
           ifelse(str_detect(genres, "Western") & !is.na(b_western), b_western, 0) +
           ifelse(str_detect(genres, "Film") & !is.na(b_film), b_film, 0) +
           ifelse(str_detect(genres, "Documentary") & !is.na(b_documentary), 
                  b_documentary, 0) +
           ifelse(str_detect(genres, "IMAX") & !is.na(b_imax), b_imax, 0)
  ) %>%
  mutate(movieYear = as.numeric(str_match(title, "(\\d{4})\\)$")[,2])) %>%
  left_join(movieYear_effect) %>% 
  mutate(newpred = newpred + knn) %>%
  .$newpred

rmse_val <- RMSE(pred, validation$rating)
rmse_val
```
The RMSE of our model to the validation set is `r round(rmse_val,4)`.

# IV. Conclusion  
Using the 10M version of the MovieLens dataset, we were able to create a movie recommendation system. The effects/biases that were used for the algorithm was the user effect, movie effect, genre effect, and year movie released effect. Regularization was done on the user effect, movie effect, and genre effect to avoid noisy estimates and overfitting. All training and model comparisons was done solely on the edx set. The validation set was used in the end to check the RMSE of the final model. The final RMSE of our model to the validation set is `r round(rmse_val,4)`. The model may possibly be improved if principal component analysis could be utilized to detect potential structures from the data to fit the model into.
